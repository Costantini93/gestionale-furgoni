<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Rider - Gestionale Furgoni</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4CAF50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ROBI Furgoni">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/images/icon.svg">
  <link rel="apple-touch-icon" href="/images/icon-192x192.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/premium.css">
  <link rel="stylesheet" href="/css/clean-theme.css">
  <script>
    // Toast Notification System (definita nel head per essere accessibile subito)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>
</head>
<body>
  <div class="topbar">
    <div class="breadcrumb">
      <span>Dashboard </span>
    </div>
    <div class="topbar-right">
      <div class="user-info">
        <span><%= user.nome %> <%= user.cognome %></span>
      </div>
      <a href="/auth/logout" class="btn btn-secondary">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="section-header">
      <h2>Dashboard Driver</h2>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Spinner -->
    <div class="spinner-overlay" id="loadingSpinner" style="display: none;">
      <div class="spinner"></div>
    </div>

    <% if (success && success.length > 0) { %>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          showToast('<%= success[0] %>', 'success');
        });
      </script>
    <% } %>

    <% if (error && error.length > 0) { %>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          showToast('<%= error[0] %>', 'error');
        });
      </script>
    <% } %>

    <!-- Alert Sostituzione Furgone -->
    <% if (substitutionReport) { %>
      <div class="alert" style="background: #fef3c7; border: 2px solid #f59e0b; margin-bottom: 2rem;">
        <h3 style="color: #92400e;">üîÑ Furgone Sostituito!</h3>
        <p style="color: #92400e;">
          Il tuo furgone √® stato cambiato. <strong>Compila il form di partenza per il nuovo furgone: <%= substitutionReport.targa_furgone %></strong>
        </p>
        <p style="color: #92400e; font-size: 0.9rem; margin-top: 0.5rem;">
          <strong>Motivo:</strong> <%= substitutionReport.substitution_reason %>
        </p>
        <button 
          class="btn" 
          style="background: #f59e0b; color: white; margin-top: 1rem;"
          onclick="document.getElementById('substitutionFormSection').scrollIntoView({ behavior: 'smooth' })">
          Vai al Form ‚Üí
        </button>
      </div>
    <% } %>

    <!-- Sezione Report Aperti (DA COMPLETARE) -->
    <% if (openReports && openReports.length > 0) { %>
      <div class="alert alert-warning">
        <h3>‚ö†Ô∏è Report da Completare</h3>
        <p>
          Hai <strong><%= openReports.length %></strong> rientro/i da registrare:
        </p>
        
        <% openReports.forEach(report => { %>
          <div class="open-report-card">
            <div class="open-report-info">
              <h4><%= formatDate(report.data_giorno) %></h4>
              <p>
                <strong>Targa:</strong> <%= report.targa_furgone %> | 
                <strong>Rotta:</strong> <%= report.codice_rotta %> | 
                <strong>KM Partenza:</strong> <%= report.km_partenza %>
              </p>
            </div>
            
            <button 
              class="btn btn-warning" 
              onclick="openCompleteModal(<%= report.id %>, '<%= report.data_giorno %>', '<%= report.targa_furgone %>', <%= report.km_partenza %>)"
              style="background: #f59e0b; min-width: 180px;">
              Completa Rientro
            </button>
          </div>
        <% }) %>
      </div>
    <% } %>

    <!-- Furgone Assegnato (solo se ci sono report attivi) -->
    <% if (assignment && (preparationReport || (openReports && openReports.length > 0))) { %>
      <div class="card">
        <div class="card-header">
          <h3>üöö Il tuo furgone</h3>
          <span class="badge badge-success">ASSEGNATO</span>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 1rem; color: #64748b;">
            Assegnato dal <%= new Date(assignment.data_assegnazione).toLocaleDateString('it-IT') %>
          </p>

          <div class="form-row">
            <div class="form-group">
              <label>Targa</label>
              <p style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin: 0.5rem 0;">
                <%= assignment.targa %>
              </p>
            </div>
            <div class="form-group">
              <label>Modello</label>
              <p style="font-size: 1.125rem; font-weight: 600; color: #1e293b; margin: 0.5rem 0;">
                <%= assignment.modello %>
              </p>
            </div>
          </div>

          <button onclick="showMaintenanceModal('<%= assignment.vehicle_id %>', '<%= assignment.targa %>')" class="btn btn-warning">
            Segnala Problema
          </button>
        </div>
      </div>
    <% } %>

    <!-- Form inserimento PARTENZA -->
    <div class="card" id="<%= substitutionReport ? 'substitutionFormSection' : '' %>">
      <% if (preparationReport || substitutionReport) { %>
        <% const activeReport = substitutionReport || preparationReport; %>
        <div class="card-header">
          <h3><%= substitutionReport ? 'üîÑ Completa Partenza con Nuovo Furgone' : 'Completa la Tua Partenza' %></h3>
        </div>
        <div class="card-body">
          <p style="color: #64748b; margin-bottom: 1.5rem;">
            <% if (substitutionReport) { %>
              <strong style="color: #f59e0b;">Furgone sostituito:</strong> Compila i dati per il nuovo furgone <%= activeReport.targa_furgone %>
            <% } else { %>
              Assegnamento del <%= new Date(activeReport.data_giorno).toLocaleDateString('it-IT') %> - Completa i dati e scatta le 5 foto prima di partire
            <% } %>
          </p>
        <form action="/rider/report/create" method="POST" id="reportForm" enctype="multipart/form-data">
          <input type="hidden" name="report_id" value="<%= activeReport.id %>">
          
          <div class="form-row">
            <div class="form-group">
              <label for="data_giorno">Data</label>
              <input type="date" id="data_giorno" name="data_giorno" value="<%= activeReport.data_giorno %>" readonly>
            </div>

            <div class="form-group">
              <label for="targa_furgone">Targa Furgone</label>
              <input type="text" id="targa_furgone" name="targa_furgone" value="<%= activeReport.targa_furgone %>" readonly>
            </div>

            <div class="form-group">
              <label for="codice_rotta">Codice Rotta *</label>
              <input type="text" id="codice_rotta" name="codice_rotta" placeholder="ES: R001" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="km_partenza">Km Partenza *</label>
              <input type="number" id="km_partenza" name="km_partenza" min="0" required>
            </div>

            <div class="form-group">
              <label for="orario_partenza">Orario Partenza *</label>
              <input type="time" id="orario_partenza" name="orario_partenza" required>
            </div>

            <div class="form-group">
              <label for="numero_aziendale">Numero Aziendale</label>
              <input type="text" id="numero_aziendale" name="numero_aziendale" placeholder="Opzionale">
            </div>

            <div class="form-group">
              <label>Firma qui sotto per confermare *</label>
              <div style="border: 2px solid #3b82f6; border-radius: 8px; background: white; margin-bottom: 0.5rem;">
                <canvas id="signatureCanvas" width="600" height="200" style="display: block; width: 100%; height: auto; touch-action: none;"></canvas>
              </div>
              <button type="button" onclick="clearSignature()" class="btn btn-secondary">
                Cancella Firma
              </button>
              <input type="hidden" id="firma" name="firma" required>
            </div>
          </div>

          <!-- Foto Furgone -->
          <div class="form-section">
            <h4>Foto del Furgone (Obbligatorie)</h4>
            <p style="color: #64748b; margin-bottom: 1.5rem;">
              Scatta o carica 5 foto del furgone prima di partire
            </p>

            <div class="foto-grid">
              <div class="foto-upload-box">
                <label for="foto_posteriore" class="foto-label">
                  <span>Foto Posteriore *</span>
                  <input type="file" id="foto_posteriore" name="foto_posteriore" accept="image/*" capture="environment" required>
                </label>
                <div class="foto-preview" id="preview_posteriore"></div>
                <div class="foto-upload-progress" id="progress_posteriore">
                  <div class="foto-upload-progress-bar"></div>
                </div>
                <div class="foto-success" id="success_posteriore"></div>
              </div>

              <div class="foto-upload-box">
                <label for="foto_anteriore" class="foto-label">
                  <span>Foto Anteriore *</span>
                  <input type="file" id="foto_anteriore" name="foto_anteriore" accept="image/*" capture="environment" required>
                </label>
                <div class="foto-preview" id="preview_anteriore"></div>
                <div class="foto-upload-progress" id="progress_anteriore">
                  <div class="foto-upload-progress-bar"></div>
                </div>
                <div class="foto-success" id="success_anteriore"></div>
              </div>

            <div class="foto-upload-box">
              <label for="foto_lato_destro" class="foto-label">
                <span>Lato Destro *</span>
                <input type="file" id="foto_lato_destro" name="foto_lato_destro" accept="image/*" capture="environment" required>
              </label>
              <div class="foto-preview" id="preview_lato_destro"></div>
              <div class="foto-upload-progress" id="progress_lato_destro">
                <div class="foto-upload-progress-bar"></div>
              </div>
              <div class="foto-success" id="success_lato_destro"></div>
            </div>

            <div class="foto-upload-box">
              <label for="foto_lato_sinistro" class="foto-label">
                <span>Lato Sinistro *</span>
                <input type="file" id="foto_lato_sinistro" name="foto_lato_sinistro" accept="image/*" capture="environment" required>
              </label>
              <div class="foto-preview" id="preview_lato_sinistro"></div>
              <div class="foto-upload-progress" id="progress_lato_sinistro">
                <div class="foto-upload-progress-bar"></div>
              </div>
              <div class="foto-success" id="success_lato_sinistro"></div>
            </div>

            <div class="foto-upload-box">
              <label for="foto_interno" class="foto-label">
                <span>Interno *</span>
                <input type="file" id="foto_interno" name="foto_interno" accept="image/*" capture="environment" required>
              </label>
              <div class="foto-preview" id="preview_interno"></div>
              <div class="foto-upload-progress" id="progress_interno">
                <div class="foto-upload-progress-bar"></div>
              </div>
              <div class="foto-success" id="success_interno"></div>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">
          Registra Partenza
        </button>
      </form>
      <% } else { %>
        <div class="card" style="text-align: center; padding: 3rem;">
          <h3 style="color: #7F8C8D; margin-bottom: 1rem;">Nessun Assegnamento</h3>
          <p style="color: #95A5A6;">Non hai assegnamenti per oggi. Contatta l'amministratore per ottenere un assegnamento.</p>
        </div>
      <% } %>
    </div>

    <!-- Modal Completa Rientro -->
    <div id="completeModal" class="photo-modal" style="background: rgba(0,0,0,0.5);">
      <div class="photo-modal-content" style="max-width: 500px; background: #FFFFFF;">
        <button class="photo-modal-close" onclick="closeCompleteModal()" style="color: #2C3E50;">√ó</button>
        <h3 style="color: #27AE60; margin-bottom: 1rem;">Completa Rientro</h3>
        
        <div id="modalReportInfo" style="background: #F8F9FA; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #E0E0E0;">
          <!-- Info report compilata da JS -->
        </div>

        <form id="completeForm" method="POST" action="">
          <div class="form-group">
            <label for="km_rientro_modal" style="color: #2C3E50; font-weight: 500;">Km Rientro *</label>
            <input 
              type="number" 
              id="km_rientro_modal" 
              name="km_rientro" 
              min="0" 
              required
              class="form-control">
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label for="orario_rientro_modal" style="color: #2C3E50; font-weight: 500;">Orario Rientro *</label>
            <input 
              type="time" 
              id="orario_rientro_modal" 
              name="orario_rientro" 
              required
              class="form-control">
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label for="pacchi_ritornati_modal" style="color: #2C3E50; font-weight: 500;">Pacchi Ritornati</label>
            <input 
              type="number" 
              id="pacchi_ritornati_modal" 
              name="pacchi_ritornati" 
              min="0"
              value="0"
              class="form-control">
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label for="tipo_rifornimento_modal" style="color: #2C3E50; font-weight: 500;">Tipo Rifornimento</label>
            <select 
              id="tipo_rifornimento_modal" 
              name="metodo_rifornimento"
              class="form-control"
              onchange="toggleRifornimentoFields()">
              <option value="">Nessun Rifornimento</option>
              <option value="IP">IP</option>
              <option value="DKV">DKV</option>
            </select>
          </div>

          <div id="rifornimento_ip_fields" style="display: none; margin-top: 1rem;">
            <div class="form-group">
              <label for="importo_rifornimento_modal" style="color: #2C3E50; font-weight: 500;">Importo Rifornimento (‚Ç¨) *</label>
              <input 
                type="number" 
                id="importo_rifornimento_modal" 
                name="rifornimento_ip" 
                min="0"
                step="0.01"
                placeholder="0.00"
                class="form-control">
            </div>
          </div>

          <div id="rifornimento_dkv_fields" style="display: none; margin-top: 1rem;">
            <div class="form-group">
              <label for="numero_dkv_modal" style="color: #2C3E50; font-weight: 500;">Numero Scheda DKV *</label>
              <input 
                type="text" 
                id="numero_dkv_modal" 
                name="numero_scheda_dkv" 
                placeholder="Inserisci numero DKV"
                class="form-control">
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="importo_dkv_modal" style="color: #2C3E50; font-weight: 500;">Importo Rifornimento (‚Ç¨) *</label>
              <input 
                type="number" 
                id="importo_dkv_modal" 
                name="rifornimento_dkv" 
                min="0"
                step="0.01"
                placeholder="0.00"
                class="form-control">
            </div>
          </div>

          <div id="kmCalculation" style="margin-top: 1rem; padding: 1rem; background: #10b981; border-radius: 8px; display: none;">
            <strong style="color: white; font-size: 1.1rem;">ÔøΩÔøΩ KM Percorsi: <span id="kmPercorsi">0</span></strong>
          </div>

          <div class="form-row" style="margin-top: 1.5rem; gap: 0.75rem;">
            <button type="button" class="btn btn-secondary" onclick="closeCompleteModal()" style="flex: 1;">
              Annulla
            </button>
            <button type="submit" class="btn btn-success" style="flex: 1; background: #10b981;">
              Conferma Rientro
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Messaggio quando non ci sono turni attivi -->
    <% if (!preparationReport && (!openReports || openReports.length === 0)) { %>
      <div class="card" style="text-align: center; padding: 3rem;">
        <h3 style="color: #7F8C8D; margin-bottom: 1rem;">Nessun Turno Attivo</h3>
        <p style="color: #95A5A6;">Non hai turni da completare al momento. Controlla piÔøΩ tardi o contatta l'amministratore.</p>
      </div>
    <% } %>
  </div>

  <script>
    // ===== FUNZIONE TOGGLE CAMPI RIFORNIMENTO =====
    function toggleRifornimentoFields() {
      const tipoRifornimento = document.getElementById('tipo_rifornimento_modal').value;
      const ipFields = document.getElementById('rifornimento_ip_fields');
      const dkvFields = document.getElementById('rifornimento_dkv_fields');
      
      // Nascondi entrambi
      ipFields.style.display = 'none';
      dkvFields.style.display = 'none';
      
      // Rimuovi required da tutti i campi
      document.getElementById('importo_rifornimento_modal').removeAttribute('required');
      document.getElementById('numero_dkv_modal').removeAttribute('required');
      document.getElementById('importo_dkv_modal').removeAttribute('required');
      
      // Mostra i campi appropriati
      if (tipoRifornimento === 'IP') {
        ipFields.style.display = 'block';
        document.getElementById('importo_rifornimento_modal').setAttribute('required', 'required');
      } else if (tipoRifornimento === 'DKV') {
        dkvFields.style.display = 'block';
        document.getElementById('numero_dkv_modal').setAttribute('required', 'required');
        document.getElementById('importo_dkv_modal').setAttribute('required', 'required');
      }
    }

    // ===== MODAL COMPLETA RIENTRO =====
    let currentReportId = null;
    let currentKmPartenza = 0;

    function openCompleteModal(reportId, dataGiorno, targa, kmPartenza) {
      currentReportId = reportId;
      currentKmPartenza = parseInt(kmPartenza);
      
      // Formatta la data per il display (da YYYY-MM-DD a DD/MM/YYYY)
      const formattedDate = new Date(dataGiorno).toLocaleDateString('it-IT');
      
      // Imposta info report nel modal
      document.getElementById('modalReportInfo').innerHTML = `
        <p style="margin: 0; color: #2C3E50;">
          <strong>Data:</strong> ${formattedDate}<br>
          <strong>Targa:</strong> ${targa}<br>
          <strong>KM Partenza:</strong> ${kmPartenza}
        </p>
      `;
      
      // Imposta action del form
      document.getElementById('completeForm').action = `/rider/report/complete/${reportId}`;
      
      // Imposta ora attuale
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('orario_rientro_modal').value = `${hours}:${minutes}`;
      
      // Reset km rientro
      document.getElementById('km_rientro_modal').value = '';
      document.getElementById('kmCalculation').style.display = 'none';
      
      // Mostra modal
      document.getElementById('completeModal').classList.add('active');
    }

    function closeCompleteModal() {
      document.getElementById('completeModal').classList.remove('active');
      currentReportId = null;
      currentKmPartenza = 0;
    }

    // Imposta la data di oggi nel date picker (solo se esiste)
    const dataGiornoInput = document.getElementById('data_giorno');
    if (dataGiornoInput) {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      dataGiornoInput.value = `${year}-${month}-${day}`;
    }

    // Dati utente per watermark (definiti fuori dalle funzioni)
    const userFullName = '<%= user.nome %> <%= user.cognome %>';

    // Compressione e Watermark Immagini
    async function compressAndWatermarkImage(file, inputId) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Ridimensiona se troppo grande (max 1920px)
            let width = img.width;
            let height = img.height;
            const maxSize = 1920;
            
            if (width > maxSize || height > maxSize) {
              if (width > height) {
                height = (height / width) * maxSize;
                width = maxSize;
              } else {
                width = (width / height) * maxSize;
                height = maxSize;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Disegna immagine
            ctx.drawImage(img, 0, 0, width, height);
            
            // Aggiungi watermark
            const watermarkText = new Date().toLocaleString('it-IT') + ' - ' + userFullName;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, height - 40, width, 40);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText(watermarkText, 10, height - 15);
            
            // Converti in WebP con compressione
            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name.replace(/\.[^/.]+$/, '.webp'), {
                type: 'image/webp',
                lastModified: Date.now()
              }));
            }, 'image/webp', 0.85);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Gestione foto con progress e feedback
    const fotoInputs = ['foto_posteriore', 'foto_anteriore', 'foto_lato_destro', 'foto_lato_sinistro', 'foto_interno'];
    
    fotoInputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      const preview = document.getElementById('preview_' + inputId.replace('foto_', ''));
      const progress = document.getElementById('progress_' + inputId.replace('foto_', ''));
      const success = document.getElementById('success_' + inputId.replace('foto_', ''));
      const label = input.closest('.foto-label');
      
      input.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (file) {
          // Mostra progress
          progress.classList.add('active');
          
          try {
            // Comprimi e aggiungi watermark
            const processedFile = await compressAndWatermarkImage(file, inputId);
            
            // Crea anteprima
            const reader = new FileReader();
            reader.onload = function(event) {
              preview.innerHTML = `<img src="${event.target.result}" alt="Anteprima">`;
              preview.classList.add('active');
              label.classList.add('has-image');
              
              // Nascondi progress, mostra success
              progress.classList.remove('active');
              success.classList.add('active');
              
              setTimeout(() => {
                success.classList.remove('active');
              }, 1500);
              
              showToast(`Foto ${inputId.replace('foto_', '').replace('_', ' ')} caricata e ottimizzata!`, 'success');
            };
            reader.readAsDataURL(processedFile);
            
            // Sostituisci il file originale con quello processato
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(processedFile);
            input.files = dataTransfer.files;
            
          } catch (error) {
            progress.classList.remove('active');
            showToast('Errore nel processamento dell\'immagine', 'error');
          }
        }
      });
    });

    // Autocomplete per Targa e Rotta
    const targaInput = document.getElementById('targa_furgone');
    const rottaInput = document.getElementById('codice_rotta');
    
    // Raccogli targhe e rotte esistenti dalla tabella
    const existingData = {
      targhe: new Set(),
      rotte: new Set()
    };
    
    document.querySelectorAll('.data-table tbody tr').forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length > 1) {
        existingData.targhe.add(cells[1].textContent.trim());
        existingData.rotte.add(cells[2].textContent.trim());
      }
    });
    
    // Aggiungi datalist per autocomplete
    if (existingData.targhe.size > 0) {
      const targaDatalist = document.createElement('datalist');
      targaDatalist.id = 'targa-list';
      existingData.targhe.forEach(targa => {
        const option = document.createElement('option');
        option.value = targa;
        targaDatalist.appendChild(option);
      });
      document.body.appendChild(targaDatalist);
      targaInput.setAttribute('list', 'targa-list');
    }
    
    if (existingData.rotte.size > 0) {
      const rottaDatalist = document.createElement('datalist');
      rottaDatalist.id = 'rotta-list';
      existingData.rotte.forEach(rotta => {
        const option = document.createElement('option');
        option.value = rotta;
        rottaDatalist.appendChild(option);
      });
      document.body.appendChild(rottaDatalist);
      rottaInput.setAttribute('list', 'rotta-list');
    }

    // Mostra spinner al submit
    document.getElementById('reportForm').addEventListener('submit', function() {
      document.getElementById('loadingSpinner').style.display = 'flex';
    });

    // Modal per visualizzare foto
    function openPhotoModal(photoUrl, caption) {
      const modal = document.createElement('div');
      modal.className = 'photo-modal active';
      modal.innerHTML = `
        <div class="photo-modal-content">
          <button class="photo-modal-close" onclick="this.closest('.photo-modal').remove()">ÔøΩ</button>
          <img src="${photoUrl}" alt="${caption}">
          <div class="photo-modal-caption">${caption}</div>
        </div>
      `;
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
  </script>

  <!-- Modal Segnalazione Manutenzione -->
  <div id="maintenanceModal" class="modal" style="display: none;">
    <div class="modal-content glass-card" style="max-width: 600px;">
      <h3>Segnala Problema con AI</h3>
      <form action="/rider/maintenance/create" method="POST" id="maintenanceForm">
        <input type="hidden" id="maintenance_vehicle_id" name="vehicle_id">
        
        <div class="form-group">
          <label>Furgone:</label>
          <input type="text" id="maintenance_vehicle_targa" readonly style="background: rgba(30, 41, 59, 0.5);">
        </div>

        <div class="form-group">
          <label>Descrizione Problema *</label>
          <textarea 
            id="issue_description" 
            name="issue_description" 
            rows="4" 
            required 
            placeholder="Descrivi il problema riscontrato... L'AI analizzer√† la gravit√†!"
            style="resize: vertical;"></textarea>
          <small style="color: #7F8C8D; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
            Scrivi dettagli come: rumore, vibrazione, perdite, luci, funzionamento...
          </small>
        </div>

        <!-- AI Priority Preview -->
        <div id="aiPriorityPreview" style="display: none; margin: 1rem 0; padding: 1rem; border-radius: 12px; background: rgba(99, 102, 241, 0.1); border: 2px solid rgba(99, 102, 241, 0.3);">
          <div style="margin-bottom: 0.5rem;">
            <strong style="color: #a5b4fc; font-size: 0.875rem;">AI ANALISI:</strong>
            <div id="aiSuggestion" style="font-size: 1.125rem; font-weight: 600; margin-top: 0.25rem;"></div>
          </div>
          <div id="aiExplanation" style="font-size: 0.875rem; color: #2C3E50; margin-top: 0.5rem;"></div>
        </div>

        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            Priorit√†: 
            <small style="color: #7F8C8D; font-weight: normal;">(Lascia vuoto per usare AI)</small>
          </label>
          <select id="priority_select" name="priority">
            <option value="">Automatica (AI)</option>
            <option value="bassa">Bassa - Non urgente</option>
            <option value="media">Media - Importante</option>
            <option value="alta">Alta - Urgente</option>
          </select>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <button type="submit" class="btn btn-warning">
            Invia Richiesta
          </button>
          <button type="button" onclick="closeMaintenanceModal()" class="btn btn-secondary">
            Annulla
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let aiDebounceTimer = null;

    function showMaintenanceModal(vehicleId, targa) {
      document.getElementById('maintenance_vehicle_id').value = vehicleId;
      document.getElementById('maintenance_vehicle_targa').value = targa;
      document.getElementById('issue_description').value = '';
      document.getElementById('priority_select').value = '';
      document.getElementById('aiPriorityPreview').style.display = 'none';
      document.getElementById('maintenanceModal').style.display = 'flex';
    }

    function closeMaintenanceModal() {
      document.getElementById('maintenanceModal').style.display = 'none';
    }

    // AI Live Preview
    document.getElementById('issue_description').addEventListener('input', function() {
      const description = this.value.trim();
      
      // Clear previous timer
      if (aiDebounceTimer) clearTimeout(aiDebounceTimer);
      
      if (description.length < 10) {
        document.getElementById('aiPriorityPreview').style.display = 'none';
        return;
      }

      // Debounce 500ms
      aiDebounceTimer = setTimeout(() => {
        fetch('/rider/maintenance/preview-priority', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ issue_description: description })
        })
        .then(res => res.json())
        .then(data => {
          const preview = document.getElementById('aiPriorityPreview');
          const suggestion = document.getElementById('aiSuggestion');
          const explanation = document.getElementById('aiExplanation');

          // Badge colore - solo pallini
          let badgeColor, priorityDot;
          if (data.priority === 'alta') {
            badgeColor = '#ef4444';
            priorityDot = '<span style="display: inline-block; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; margin-right: 8px;"></span>';
          } else if (data.priority === 'media') {
            badgeColor = '#f59e0b';
            priorityDot = '<span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; margin-right: 8px;"></span>';
          } else {
            badgeColor = '#10b981';
            priorityDot = '<span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 50%; margin-right: 8px;"></span>';
          }

          suggestion.innerHTML = `${priorityDot}Priorit√†: <span style="color: ${badgeColor}">${data.priority.toUpperCase()}</span>`;
          explanation.textContent = data.explanation;
          
          preview.style.display = 'block';
        })
        .catch(err => {
          console.error('AI error:', err);
        });
      }, 500);
    });

    // Chiudi modal cliccando fuori
    document.getElementById('maintenanceModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMaintenanceModal();
      }
    });

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // === CANVAS FIRMA DIGITALE ===
    const canvas = document.getElementById('signatureCanvas');
    console.log('Canvas element:', canvas);
    
    if (canvas) {
      const ctx = canvas.getContext('2d');
      const firmaInput = document.getElementById('firma');
      let isDrawing = false;
      let hasSignature = false;
      
      console.log('Canvas trovato, dimensioni:', canvas.width, 'x', canvas.height);
      console.log('Firma input:', firmaInput);

      // Imposta stile canvas
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Funzione globale per clear signature
      window.clearSignature = function() {
        console.log('Clear signature called');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasSignature = false;
        firmaInput.value = '';
      };

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        // Scala le coordinate in base alla dimensione reale vs dimensione visiva
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        return { x, y };
      }

      function startDrawing(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        console.log('Start drawing at', pos);
      }

      function draw(e) {
        e.preventDefault();
        if (!isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        hasSignature = true;
      }

      function stopDrawing(e) {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
        if (hasSignature) {
          firmaInput.value = canvas.toDataURL('image/png');
          console.log('Firma salvata, lunghezza:', firmaInput.value.length);
        }
      }

      function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0] || e.changedTouches[0];
        const mouseEvent = new MouseEvent(
          e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup',
          {
            clientX: touch.clientX,
            clientY: touch.clientY,
            bubbles: true
          }
        );
        canvas.dispatchEvent(mouseEvent);
      }

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);

      // Touch events  
      canvas.addEventListener('touchstart', handleTouch, { passive: false });
      canvas.addEventListener('touchmove', handleTouch, { passive: false });
      canvas.addEventListener('touchend', handleTouch, { passive: false });
      
      console.log('Canvas events attached successfully');
      
      // Validazione form - controlla firma
      const reportForm = document.querySelector('form[action="/rider/report/create"]');
      if (reportForm) {
      reportForm.addEventListener('submit', function(e) {
        if (!hasSignature) {
          e.preventDefault();
          alert('Per favore, firma prima di inviare il report!');
          canvas.style.border = '2px solid #ef4444';
          setTimeout(() => {
            canvas.style.border = '2px solid #6366f1';
          }, 2000);
        }
      });
    }
  } // Fine if canvas
  </script>
      </div>
    </main>
  </div>
</body>
</html>







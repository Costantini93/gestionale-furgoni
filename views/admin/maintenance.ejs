<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manutenzioni - Admin</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/premium.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <div class="nav-left">
        <h1>ğŸ”§ Richieste Manutenzione</h1>
      </div>
      <div class="nav-right">
        <a href="/admin/dashboard" class="btn btn-secondary">â† Dashboard</a>
        <a href="/admin/assignments" class="btn-gradient">ğŸšš Assegnazioni</a>
        <span class="user-info">ğŸ‘¤ <%= user.nome %> <%= user.cognome %></span>
        <a href="/auth/logout" class="btn btn-secondary">ğŸšª Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="section-header">
      <h2>ğŸ”§ Sistema Gestione Manutenzioni</h2>
    </div>

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success">âœ… <%= success[0] %></div>
    <% } %>
    <% if (error && error.length > 0) { %>
      <div class="alert alert-error">âš ï¸ <%= error[0] %></div>
    <% } %>

    <!-- Stats -->
    <div class="features-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 2rem;">
      <div class="stat-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%); border-color: rgba(245, 158, 11, 0.3);">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
          â³
        </div>
        <div class="stat-content">
          <h3 style="color: #f59e0b;">
            <%= requests.filter(r => r.status === 'pending').length %>
          </h3>
          <p>In Attesa</p>
        </div>
      </div>

      <div class="stat-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%); border-color: rgba(59, 130, 246, 0.3);">
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
          ğŸ”§
        </div>
        <div class="stat-content">
          <h3 style="color: #3b82f6;">
            <%= requests.filter(r => r.status === 'in-progress').length %>
          </h3>
          <p>In Riparazione</p>
        </div>
      </div>

      <div class="stat-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); border-color: rgba(16, 185, 129, 0.3);">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          âœ…
        </div>
        <div class="stat-content">
          <h3 style="color: #10b981;">
            <%= requests.filter(r => r.status === 'resolved').length %>
          </h3>
          <p>Risolte</p>
        </div>
      </div>
    </div>

    <!-- Lista Richieste -->
    <% if (requests && requests.length > 0) { %>
      <% requests.forEach(request => { %>
        <div class="maintenance-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #f8fafc;">
                ğŸš <%= request.targa %> - <%= request.modello %>
              </h3>
              <p style="margin: 0; color: #94a3b8; font-size: 0.875rem;">
                Segnalato da: <%= request.reporter_name %>
              </p>
              <p style="margin: 0.25rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                <%= new Date(request.created_at).toLocaleString('it-IT') %>
              </p>
            </div>

            <div>
              <% if (request.status === 'pending') { %>
                <span class="maintenance-status status-pending">â³ In Attesa</span>
              <% } else if (request.status === 'in-progress') { %>
                <span class="maintenance-status status-in-progress">ğŸ”§ In Riparazione</span>
              <% } else { %>
                <span class="maintenance-status status-completed">âœ… Risolto</span>
              <% } %>
            </div>
          </div>

          <div style="padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 10px; margin-bottom: 1rem;">
            <div style="display: flex; align-items: start; gap: 0.5rem;">
              <span style="font-size: 1.25rem;">âš ï¸</span>
              <div style="flex: 1;">
                <p style="margin: 0; color: #e2e8f0; font-weight: 600; margin-bottom: 0.5rem;">
                  Problema Segnalato:
                </p>
                <p style="margin: 0; color: #cbd5e1;">
                  <%= request.issue_description %>
                </p>
              </div>
            </div>

            <div style="margin-top: 0.75rem; display: inline-flex; align-items: center; gap: 0.5rem;">
              <span style="font-weight: 600; color: #94a3b8; font-size: 0.875rem;">PrioritÃ :</span>
              <% if (request.priority === 'alta') { %>
                <span class="badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                  ğŸ”´ ALTA
                </span>
              <% } else if (request.priority === 'media') { %>
                <span class="badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                  ğŸŸ¡ MEDIA
                </span>
              <% } else { %>
                <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                  ğŸŸ¢ BASSA
                </span>
              <% } %>
            </div>
          </div>

          <% if (request.status !== 'resolved') { %>
            <button onclick="resolveRequest(<%= request.id %>)" class="btn-gradient" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              âœ… Segna come Risolto
            </button>
          <% } else if (request.resolution_notes) { %>
            <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; border-radius: 8px;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #10b981;">
                âœ… Risoluzione:
              </p>
              <p style="margin: 0; color: #cbd5e1;">
                <%= request.resolution_notes %>
              </p>
              <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                Risolto il <%= new Date(request.resolved_at).toLocaleString('it-IT') %>
              </p>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <div class="glass-card">
        <p style="text-align: center; color: #94a3b8; margin: 3rem 0; font-size: 1.125rem;">
          ğŸ‰ Nessuna richiesta di manutenzione! Tutti i furgoni funzionano perfettamente.
        </p>
      </div>
    <% } %>
  </div>

  <!-- Modal Risoluzione -->
  <div id="resolveModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div class="glass-card" style="max-width: 500px; margin: 2rem;">
      <h3>âœ… Risolvi Richiesta Manutenzione</h3>
      <form id="resolveForm" method="POST">
        <div class="form-group">
          <label>ğŸ“ Note di Risoluzione:</label>
          <textarea name="resolution_notes" rows="4" required placeholder="Descrivi l'intervento effettuato..."></textarea>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn-gradient" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            âœ… Conferma Risoluzione
          </button>
          <button type="button" onclick="closeResolveModal()" class="btn btn-secondary">
            âŒ Annulla
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function resolveRequest(id) {
      document.getElementById('resolveForm').action = `/admin/maintenance/resolve/${id}`;
      document.getElementById('resolveModal').style.display = 'flex';
    }

    function closeResolveModal() {
      document.getElementById('resolveModal').style.display = 'none';
    }
  </script>
</body>
</html>

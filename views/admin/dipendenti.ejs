<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Dipendenti - Gestionale Furgoni</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <div class="nav-left">
        <h1>ÔøΩ Gestionale Consegne - ADMIN</h1>
      </div>
      <div class="nav-right">
        <a href="/admin/dashboard" class="btn btn-secondary">üìä Dashboard</a>
        <span class="user-info">
          üë§ <%= user.nome %> <%= user.cognome %> (Admin)
        </span>
        <a href="/auth/logout" class="btn btn-secondary">üö™ Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>üë• Gestione Dipendenti</h2>

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success">
        ‚úÖ <%= success[0] %>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert alert-error">
        ‚ö†Ô∏è <%= error[0] %>
      </div>
    <% } %>

    <!-- Form Crea Nuovo Utente -->
    <div class="card">
      <h3>‚ûï Aggiungi Nuovo Utente</h3>
      <div class="info-box">
        <p><strong>‚ÑπÔ∏è Nota:</strong> Se esiste gi√† un rider con lo stesso nome e cognome, 
        lo username sar√† automaticamente modificato aggiungendo un numero progressivo 
        (es: mario_rossi, mario_rossi2, mario_rossi3, ecc.)</p>
      </div>
      <form action="/admin/dipendenti/create" method="POST" id="createRiderForm">
        <div class="form-row">
          <div class="form-group">
            <label for="nome">Nome *</label>
            <input type="text" id="nome" name="nome" required onkeyup="capitalizeAndGenerate(this)">
          </div>

          <div class="form-group">
            <label for="cognome">Cognome *</label>
            <input type="text" id="cognome" name="cognome" required onkeyup="capitalizeAndGenerate(this)">
          </div>

          <div class="form-group">
            <label for="codice_fiscale">Codice Fiscale *</label>
            <input type="text" id="codice_fiscale" name="codice_fiscale" 
                   maxlength="16" 
                   pattern="[A-Za-z0-9]{16}"
                   placeholder="ES: RSSMRA80A01H501U"
                   required 
                   style="text-transform: uppercase;"
                   onkeyup="this.value = this.value.toUpperCase()">
            <small>16 caratteri alfanumerici</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="username">Username (generato automaticamente) *</label>
            <input type="text" id="username" name="username" readonly style="background: #f0f0f0; cursor: not-allowed;">
            <small>Formato: nome_cognome (pu√≤ essere modificato dal sistema se duplicato)</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label" style="margin-top: 1.5rem;">
              <input type="checkbox" id="is_admin" name="is_admin" onchange="updateButtonText()">
              <span class="checkbox-text">üëë Crea come AMMINISTRATORE</span>
            </label>
            <small>Se selezionato, l'utente avr√† accesso completo al sistema</small>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">
          ‚ûï Crea Rider (password: 1234)
        </button>
      </form>
    </div>

    <!-- Tabella Utenti Esistenti -->
    <div class="card">
      <h3>üìã Lista Utenti</h3>
      
      <% if (riders.length === 0) { %>
        <p class="no-data">Nessun utente presente.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Ruolo</th>
                <th>Nome</th>
                <th>Cognome</th>
                <th>Codice Fiscale</th>
                <th>Username</th>
                <th>Data Creazione</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% riders.forEach(rider => { %>
                <tr id="rider-<%= rider.id %>">
                  <td><%= rider.id %></td>
                  <td>
                    <% if (rider.role === 'admin') { %>
                      <span class="badge badge-admin">üëë Admin</span>
                    <% } else { %>
                      <span class="badge badge-rider">üöö Rider</span>
                    <% } %>
                  </td>
                  <td><%= rider.nome %></td>
                  <td><%= rider.cognome %></td>
                  <td><strong><%= rider.codice_fiscale || '-' %></strong></td>
                  <td><%= rider.username %></td>
                  <td><%= new Date(rider.created_at).toLocaleDateString('it-IT') %></td>
                  <td class="actions">
                    <button onclick="editRider(<%= rider.id %>, '<%= rider.nome %>', '<%= rider.cognome %>', '<%= rider.username %>', '<%= rider.codice_fiscale || '' %>', '<%= rider.role %>')" 
                            class="btn-icon" title="Modifica">
                      ‚úèÔ∏è
                    </button>
                    <button onclick="resetPassword(<%= rider.id %>, '<%= rider.nome %>', '<%= rider.cognome %>')" 
                            class="btn-icon" title="Reset Password">
                      üîë
                    </button>
                    <button onclick="deleteRider(<%= rider.id %>, '<%= rider.nome %>', '<%= rider.cognome %>')" 
                            class="btn-icon" title="Elimina">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Modal Modifica Rider -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h3>‚úèÔ∏è Modifica Utente</h3>
      <form id="editForm" method="POST">
        <input type="hidden" id="edit_rider_id" name="rider_id">
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit_nome">Nome *</label>
            <input type="text" id="edit_nome" name="nome" required onkeyup="capitalizeAndGenerateEdit(this)">
          </div>

          <div class="form-group">
            <label for="edit_cognome">Cognome *</label>
            <input type="text" id="edit_cognome" name="cognome" required onkeyup="capitalizeAndGenerateEdit(this)">
          </div>

          <div class="form-group">
            <label for="edit_codice_fiscale">Codice Fiscale *</label>
            <input type="text" id="edit_codice_fiscale" name="codice_fiscale" 
                   maxlength="16" 
                   pattern="[A-Za-z0-9]{16}"
                   required 
                   style="text-transform: uppercase;"
                   onkeyup="this.value = this.value.toUpperCase()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_username">Username (generato automaticamente) *</label>
            <input type="text" id="edit_username" name="username" readonly style="background: #f0f0f0; cursor: not-allowed;">
          </div>

          <div class="form-group">
            <label class="checkbox-label" style="margin-top: 1.5rem;">
              <input type="checkbox" id="edit_is_admin" name="is_admin" onchange="updateEditButtonText()">
              <span class="checkbox-text">üëë Imposta come AMMINISTRATORE</span>
            </label>
            <small>Se selezionato, l'utente avr√† accesso completo al sistema</small>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" id="editSubmitBtn">üíæ Salva Modifiche</button>
          <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Annulla</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Capitalizza nome/cognome e genera username
    function capitalizeAndGenerate(input) {
      // Capitalizza il campo
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
      }
      // Genera username
      generateUsername();
    }

    // Capitalizza nome/cognome nel form modifica
    function capitalizeAndGenerateEdit(input) {
      // Capitalizza il campo
      const value = input.value.trim();
      if (value.length > 0) {
        input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
      }
      // Genera username
      generateUsernameEdit();
    }

    // Genera username automaticamente da nome e cognome
    function generateUsername() {
      const nome = document.getElementById('nome').value.trim().toLowerCase();
      const cognome = document.getElementById('cognome').value.trim().toLowerCase();
      
      if (nome && cognome) {
        const username = nome + '_' + cognome;
        // Rimuovi caratteri speciali e spazi
        const cleanUsername = username.replace(/[^a-z0-9_]/g, '');
        document.getElementById('username').value = cleanUsername;
      } else {
        document.getElementById('username').value = '';
      }
    }

    // Aggiorna testo del pulsante in base al ruolo
    function updateButtonText() {
      const isAdmin = document.getElementById('is_admin').checked;
      const btn = document.getElementById('submitBtn');
      if (isAdmin) {
        btn.innerHTML = '‚ûï Crea Amministratore (password: 1234)';
        btn.className = 'btn btn-success';
      } else {
        btn.innerHTML = '‚ûï Crea Rider (password: 1234)';
        btn.className = 'btn btn-primary';
      }
    }

    // Genera username anche per il form di modifica
    function generateUsernameEdit() {
      const nome = document.getElementById('edit_nome').value.trim().toLowerCase();
      const cognome = document.getElementById('edit_cognome').value.trim().toLowerCase();
      
      if (nome && cognome) {
        const username = nome + '_' + cognome;
        const cleanUsername = username.replace(/[^a-z0-9_]/g, '');
        document.getElementById('edit_username').value = cleanUsername;
      }
    }

    function editRider(id, nome, cognome, username, codiceFiscale, role) {
      document.getElementById('edit_rider_id').value = id;
      document.getElementById('edit_nome').value = nome;
      document.getElementById('edit_cognome').value = cognome;
      document.getElementById('edit_username').value = username;
      document.getElementById('edit_codice_fiscale').value = codiceFiscale || '';
      document.getElementById('edit_is_admin').checked = (role === 'admin');
      updateEditButtonText();

      document.getElementById('editForm').action = '/admin/dipendenti/update/' + id;
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    // Aggiorna testo del pulsante modifica in base al ruolo
    function updateEditButtonText() {
      const isAdmin = document.getElementById('edit_is_admin').checked;
      const btn = document.getElementById('editSubmitBtn');
      if (isAdmin) {
        btn.innerHTML = 'üíæ Salva come Amministratore';
        btn.className = 'btn btn-success';
      } else {
        btn.innerHTML = 'üíæ Salva come Rider';
        btn.className = 'btn btn-primary';
      }
    }

    function resetPassword(id, nome, cognome) {
      if (confirm(`Vuoi resettare la password di ${nome} ${cognome}?\n\nLa password sar√† reimpostata a: 1234\nIl rider dovr√† cambiarla al prossimo accesso.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/dipendenti/reset-password/' + id;
        document.body.appendChild(form);
        form.submit();
      }
    }

    function deleteRider(id, nome, cognome) {
      if (confirm(`‚ö†Ô∏è ATTENZIONE ‚ö†Ô∏è\n\nSei sicuro di voler eliminare il rider ${nome} ${cognome}?\n\nQuesta azione:\n- Eliminer√† il rider\n- Eliminer√† TUTTI i suoi report\n- NON pu√≤ essere annullata\n\nConfermi?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/dipendenti/delete/' + id;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
      const modal = document.getElementById('editModal');
      if (event.target == modal) {
        closeEditModal();
      }
    }
  </script>
</body>
</html>

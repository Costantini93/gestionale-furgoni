<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Furgoni - Admin</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4CAF50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ROBI Furgoni">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/images/icon.svg">
  <link rel="apple-touch-icon" href="/images/icon-192x192.png">
  
  <link rel="stylesheet" href="/css/clean-theme.css">
</head>
<body>
  <!-- Overlay per chiudere sidebar su mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/admin/dashboard" class="sidebar-logo">Gestionale Consegne</a>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/admin/vehicles" class="active">Gestione Furgoni</a></li>
        <li><a href="/admin/dipendenti">Gestione Driver</a></li>
        <li><a href="/admin/roster">Roster</a></li>
        <li><a href="/admin/assignments">Assegnamenti</a></li>
        <li>
          <a href="/admin/maintenance">
            Manutenzioni
            <% if (pendingMaintenanceCount > 0) { %>
              <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px; font-weight: 600;"><%= pendingMaintenanceCount %></span>
            <% } %>
          </a>
        </li>
        <li><a href="/admin/scadenze">Scadenze</a></li>
        <li><a href="/auth/logout">Logout</a></li>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="breadcrumb">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
          <span>Gestione Furgoni</span>
        </div>
        <div class="topbar-right">
          <div class="user-info">
            <span><%= user.nome %> <%= user.cognome %></span>
          </div>
          <a href="/auth/logout" class="btn btn-secondary btn-sm">Logout</a>
        </div>
      </div>

      <div class="container">
        <h2>Gestione Furgoni</h2>

        <% if (success && success.length > 0) { %>
          <div class="alert alert-success">
            <%= success[0] %>
          </div>
        <% } %>

        <% if (error && error.length > 0) { %>
          <div class="alert alert-error">
            <%= error[0] %>
          </div>
        <% } %>

        <!-- Filtro Data per Assegnazioni -->
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
          <label style="font-weight: 600; margin-right: 0.75rem;">ðŸ“… Visualizza assegnazioni per data:</label>
          <input type="date" id="assignmentDate" value="<%= selectedDate %>" onchange="filterAssignments()" style="padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;">
          <button onclick="clearFilter()" style="margin-left: 0.5rem; padding: 0.5rem 1rem; background: #94a3b8; color: white; border: none; border-radius: 6px; cursor: pointer;">Mostra Tutti</button>
        </div>

        <!-- Form Aggiungi Nuovo Furgone -->
        <div class="card">
          <h3>Aggiungi Nuovo Furgone</h3>
          <form action="/admin/vehicles/create" method="POST">
            <div class="form-row">
              <div class="form-group">
                <label for="targa">Targa *</label>
                <input 
                  type="text" 
                  id="targa" 
                  name="targa" 
                  required 
                  placeholder="ES: AB123CD"
                  style="text-transform: uppercase;"
                  onkeyup="this.value = this.value.toUpperCase()">
              </div>

              <div class="form-group">
                <label for="modello">Modello *</label>
                <input 
                  type="text" 
                  id="modello" 
                  name="modello" 
                  required 
                  placeholder="ES: Fiat Ducato">
              </div>

              <div class="form-group">
                <label for="anno">Anno *</label>
                <input 
                  type="number" 
                  id="anno" 
                  name="anno" 
                  required 
                  min="1990" 
                  max="2030"
                  placeholder="ES: 2021">
              </div>
            </div>

            <button type="submit" class="btn btn-primary">
              Aggiungi Furgone
            </button>
          </form>
        </div>

        <!-- Lista Furgoni -->
        <div class="card">
          <h3>Lista Furgoni (<%= vehicles.length %>)</h3>
          
          <% if (vehicles.length === 0) { %>
            <p class="no-data">Nessun furgone presente. Aggiungi il primo!</p>
          <% } else { %>
            <div class="table-responsive">
              <table class="table" id="vehiclesTable">
                <thead>
                  <tr>
                    <th>Targa</th>
                    <th>Modello</th>
                    <th>Anno</th>
                    <th>Stato</th>
                    <th>Assegnato a</th>
                    <th>Azioni</th>
                  </tr>
                </thead>
                <tbody>
                  <% vehicles.forEach(vehicle => { %>
                    <tr data-vehicle-id="<%= vehicle.id %>">
                      <td><strong><%= vehicle.targa %></strong></td>
                      <td><%= vehicle.modello %></td>
                      <td><%= vehicle.anno %></td>
                      <td>
                        <% if (vehicle.in_manutenzione) { %>
                          <span class="badge badge-danger">IN MANUTENZIONE</span>
                        <% } else { %>
                          <span class="vehicle-status">
                            <span class="badge badge-success">DISPONIBILE</span>
                          </span>
                        <% } %>
                      </td>
                      <td>
                        <span class="vehicle-assignment">-</span>
                      </td>
                      <td>
                        <% if (vehicle.status !== 'assegnato') { %>
                          <form 
                            action="/admin/vehicles/delete/<%= vehicle.id %>" 
                            method="POST" 
                            style="display: inline;"
                            onsubmit="return confirm('Sei sicuro di voler eliminare questo veicolo?')">
                            <button type="submit" class="btn btn-sm btn-danger">Elimina</button>
                          </form>
                        <% } else { %>
                          <span class="text-muted">-</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

            <!-- Statistiche -->
            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold;" id="statTotal"><%= vehicles.length %></div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">Totale</div>
              </div>
              
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold;" id="statDisponibili">
                  <%= vehicles.filter(v => !v.in_manutenzione).length %>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">Disponibili</div>
              </div>

              <div style="padding: 1.5rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold;" id="statAssegnati">
                  0
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">Assegnati</div>
              </div>
              
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold;" id="statInUso">
                  0
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">In Uso</div>
              </div>

              <div style="padding: 1.5rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; color: white; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold;" id="statManutenzione">
                  <%= vehicles.filter(v => v.in_manutenzione).length %>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">In Manutenzione</div>
              </div>
            </div>
          <% } %>
        </div>

      </div>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    let currentAssignments = {};

    async function loadAssignments(date = null) {
      try {
        const url = date ? `/admin/vehicles/assignments?date=${date}` : '/admin/vehicles/assignments';
        const response = await fetch(url);
        const data = await response.json();
        
        currentAssignments = {};
        data.forEach(assignment => {
          currentAssignments[assignment.vehicle_id] = assignment;
        });
        
        updateTable();
      } catch (error) {
        console.error('Errore nel caricamento delle assegnazioni:', error);
      }
    }

    function updateTable() {
      const rows = document.querySelectorAll('#vehiclesTable tbody tr');
      let inUsoCount = 0;
      let assegnatiCount = 0;
      let disponibiliCount = 0;
      const manutenzioneCount = <%= vehicles.filter(v => v.in_manutenzione).length %>;
      
      rows.forEach(row => {
        const vehicleId = row.dataset.vehicleId;
        const statusCell = row.querySelector('.vehicle-status');
        const assignmentCell = row.querySelector('.vehicle-assignment');
        const assignment = currentAssignments[vehicleId];
        
        // Controlla se il veicolo Ã¨ in manutenzione (badge rosso fisso)
        const isInMaintenance = statusCell && statusCell.parentElement.querySelector('.badge-danger');
        
        if (!isInMaintenance) {
          if (assignment) {
            // IN USO = report status Ã¨ 'partito' o 'completato'
            // ASSEGNATO = no report o report status Ã¨ 'in_preparazione'
            if (assignment.report_status === 'partito' || assignment.report_status === 'completato') {
              if (statusCell) {
                statusCell.innerHTML = '<span class="badge" style="background:#f59e0b;">IN USO</span>';
              }
              // Estrai orario dalla data orario_partenza_effettivo
              let timeInfo = '';
              if (assignment.orario_partenza_effettivo) {
                // SQLite datetime('now', 'localtime') restituisce giÃ  l'orario locale
                // Quindi non aggiungiamo 'Z' per evitare conversione UTC
                const dateStr = assignment.orario_partenza_effettivo.replace(' ', 'T');
                const date = new Date(dateStr);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                timeInfo = ` dalle ${hours}:${minutes}`;
              }
              assignmentCell.textContent = `${assignment.rider_nome} ${assignment.rider_cognome}${timeInfo}`;
              inUsoCount++;
            } else {
              if (statusCell) {
                statusCell.innerHTML = '<span class="badge" style="background:#3b82f6;">ASSEGNATO</span>';
              }
              assignmentCell.textContent = `${assignment.rider_nome} ${assignment.rider_cognome}`;
              assegnatiCount++;
            }
          } else {
            if (statusCell) {
              statusCell.innerHTML = '<span class="badge badge-success">DISPONIBILE</span>';
            }
            assignmentCell.textContent = '-';
            disponibiliCount++;
          }
        }
      });
      
      // Aggiorna le statistiche
      document.getElementById('statInUso').textContent = inUsoCount;
      document.getElementById('statAssegnati').textContent = assegnatiCount;
      document.getElementById('statDisponibili').textContent = disponibiliCount;
      document.getElementById('statManutenzione').textContent = manutenzioneCount;
      document.getElementById('statTotal').textContent = <%= vehicles.length %>;
    }

    function filterAssignments() {
      const date = document.getElementById('assignmentDate').value;
      if (date) {
        loadAssignments(date);
      }
    }

    function clearFilter() {
      document.getElementById('assignmentDate').value = '';
      currentAssignments = {};
      
      // Resetta tutti i veicoli non in manutenzione a DISPONIBILE
      const rows = document.querySelectorAll('#vehiclesTable tbody tr');
      let countManutenzione = <%= vehicles.filter(v => v.in_manutenzione).length %>;
      let countDisponibili = <%= vehicles.filter(v => !v.in_manutenzione).length %>;
      
      rows.forEach(row => {
        const statusCell = row.querySelector('.vehicle-status');
        const assignmentCell = row.querySelector('.vehicle-assignment');
        
        if (statusCell) {
          statusCell.innerHTML = '<span class="badge badge-success">DISPONIBILE</span>';
          assignmentCell.textContent = '-';
        }
      });
      
      // Resetta le statistiche
      document.getElementById('statDisponibili').textContent = countDisponibili;
      document.getElementById('statAssegnati').textContent = '0';
      document.getElementById('statInUso').textContent = '0';
      document.getElementById('statManutenzione').textContent = countManutenzione;
    }

    // Carica assegnazioni per la data selezionata all'avvio
    document.addEventListener('DOMContentLoaded', () => {
      const date = document.getElementById('assignmentDate').value;
      if (date) {
        loadAssignments(date);
      }
    });
  </script>
</body>
</html>

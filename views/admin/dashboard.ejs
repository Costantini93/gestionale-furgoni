<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Gestionale Furgoni</title>
  <link rel="stylesheet" href="/css/clean-theme.css">
</head>
<body>
  <!-- Overlay per chiudere sidebar su mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/admin/dashboard" class="sidebar-logo">Gestionale Consegne</a>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard" class="active">Dashboard</a></li>
        <li><a href="/admin/vehicles">Gestione Furgoni</a></li>
        <li><a href="/admin/dipendenti">Gestione Dipendenti</a></li>
        <li><a href="/admin/roster">Roster</a></li>
        <li><a href="/admin/assignments">Assegnamenti</a></li>
        <li>
          <a href="/admin/maintenance">
            Manutenzioni
            <% if (pendingMaintenanceCount > 0) { %>
              <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px; font-weight: 600;"><%= pendingMaintenanceCount %></span>
            <% } %>
          </a>
        </li>
        <li><a href="/auth/logout">Logout</a></li>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="breadcrumb">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
          <span>Gestionale Consegne - ADMIN</span>
        </div>
        <div class="topbar-right">
          <div class="user-info">
            <span><%= user.nome %> <%= user.cognome %></span>
          </div>
          <a href="/auth/logout" class="btn btn-secondary btn-sm">Logout</a>
        </div>
      </div>

      <div class="container">

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success">
        <%= success[0] %>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert alert-error">
        <%= error[0] %>
      </div>
    <% } %>

    <!-- Tabella report -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h3 style="margin: 0;">Report Consegne</h3>
        
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
          <button 
            id="deleteSelectedBtn" 
            class="btn" 
            onclick="deleteSelected()" 
            style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: none;">
            Elimina Selezionati (<span id="selectedCount">0</span>)
          </button>
          
          <button class="btn btn-secondary" onclick="filterStatus('all')" id="btnAll">
            Tutti (<span id="countAll">0</span>)
          </button>
          <button class="btn btn-warning" onclick="filterStatus('partito')" id="btnPartito">
            In Viaggio (<span id="countPartito">0</span>)
          </button>
          <button class="btn btn-success" onclick="filterStatus('completato')" id="btnCompletato">
            Rientrati (<span id="countCompletato">0</span>)
          </button>
        </div>
      </div>
      
      <% if (reports.length === 0) { %>
        <p class="no-data">Nessun report disponibile.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" title="Seleziona tutti">
                </th>
                <th class="sortable" onclick="sortTable('data_giorno')" style="cursor: pointer;">
                  Data <span class="sort-icon" id="sort-data_giorno">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('rider')" style="cursor: pointer;">
                  Rider <span class="sort-icon" id="sort-rider">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('status')" style="cursor: pointer;">
                  Stato <span class="sort-icon" id="sort-status">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('targa_furgone')" style="cursor: pointer;">
                  Targa <span class="sort-icon" id="sort-targa_furgone">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('codice_rotta')" style="cursor: pointer;">
                  Rotta <span class="sort-icon" id="sort-codice_rotta">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('km_partenza')" style="cursor: pointer;">
                  Km P. <span class="sort-icon" id="sort-km_partenza">‚áÖ</span>
                </th>
                <th>Km R.</th>
                <th class="sortable" onclick="sortTable('km_percorsi')" style="cursor: pointer;">
                  Km Tot. <span class="sort-icon" id="sort-km_percorsi">‚áÖ</span>
                </th>
                <th>Orario</th>
                <th>Foto</th>
                <th>Firma</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% reports.forEach(report => { %>
                <tr id="row-<%= report.id %>" 
                    class="<%= report.status === 'partito' ? 'row-in-viaggio' : '' %>"
                    data-data_giorno="<%= report.data_giorno %>"
                    data-rider="<%= report.nome %> <%= report.cognome %>"
                    data-status="<%= report.status %>"
                    data-targa_furgone="<%= report.targa_furgone %>"
                    data-codice_rotta="<%= report.codice_rotta %>"
                    data-km_partenza="<%= report.km_partenza %>"
                    data-km_percorsi="<%= report.km_rientro ? report.km_rientro - report.km_partenza : 0 %>">
                  <td>
                    <input type="checkbox" class="report-checkbox" value="<%= report.id %>" onchange="updateDeleteButton()">
                  </td>
                  <td><%= formatDate(report.data_giorno) %></td>
                  <td><strong><%= report.nome %> <%= report.cognome %></strong></td>
                  <td>
                    <% if (report.status === 'partito') { %>
                      <span class="badge badge-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #fb923c 100%); animation: pulse-warning 2s infinite;">
                        In Viaggio
                      </span>
                    <% } else { %>
                      <span class="badge badge-success">
                        Rientrato
                      </span>
                    <% } %>
                  </td>
                  <td><%= report.targa_furgone %></td>
                  <td><%= report.codice_rotta %></td>
                  <td><%= report.km_partenza %></td>
                  <td>
                    <% if (report.km_rientro) { %>
                      <%= report.km_rientro %>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.km_rientro) { %>
                      <strong><%= report.km_rientro - report.km_partenza %></strong>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.orario_rientro) { %>
                      <%= report.orario_rientro %>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.foto_posteriore || report.foto_anteriore || report.foto_lato_destro || report.foto_lato_sinistro || report.foto_interno) { %>
                      <button class="btn btn-sm btn-secondary" onclick="showPhotosModal('<%= report.id %>', '<%= report.nome %> <%= report.cognome %>', '<%= formatDate(report.data_giorno) %>', '<%= report.foto_posteriore || "" %>', '<%= report.foto_anteriore || "" %>', '<%= report.foto_lato_destro || "" %>', '<%= report.foto_lato_sinistro || "" %>', '<%= report.foto_interno || "" %>')" title="Vedi foto">
                        Foto (<%= [report.foto_posteriore, report.foto_anteriore, report.foto_lato_destro, report.foto_lato_sinistro, report.foto_interno].filter(Boolean).length %>)
                      </button>
                    <% } else { %>
                      <span style="color: #94a3b8;">Nessuna</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.firma) { %>
                      <span class="badge badge-success">‚úì</span>
                    <% } else { %>
                      <span class="badge badge-error">‚úó</span>
                    <% } %>
                  </td>
                  <td class="actions">
                    <button onclick="editReport(<%= report.id %>)" class="btn-icon btn-sm btn-primary" title="Modifica">
                      ‚úè
                    </button>
                    <button onclick="deleteReport(<%= report.id %>)" class="btn-icon btn-sm btn-danger" title="Elimina">
                      √ó
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Modal Modifica Report -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h3>‚úèÔ∏è Modifica Report</h3>
      
      <div id="statusWarning" style="display: none; background: rgba(245, 158, 11, 0.2); border: 2px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p style="margin: 0; color: #fbbf24; font-weight: 600;">
          ‚ö†Ô∏è Questo report √® ancora "In Viaggio". Inserisci KM Rientro e Orario per completarlo.
        </p>
      </div>

      <form id="editForm" method="POST">
        <input type="hidden" id="edit_report_id" name="report_id">
        <input type="hidden" id="edit_current_status" name="current_status">
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit_targa_furgone">Targa Furgone</label>
            <input type="text" id="edit_targa_furgone" name="targa_furgone" required>
          </div>

          <div class="form-group">
            <label for="edit_codice_rotta">Codice Rotta</label>
            <input type="text" id="edit_codice_rotta" name="codice_rotta" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_km_partenza">Km Partenza *</label>
            <input type="number" id="edit_km_partenza" name="km_partenza" required>
          </div>

          <div class="form-group">
            <label for="edit_km_rientro">
              Km Rientro <span id="labelKmOptional" style="color: #94a3b8; font-size: 0.85rem;">(Opzionale se in viaggio)</span>
            </label>
            <input type="number" id="edit_km_rientro" name="km_rientro">
          </div>

          <div class="form-group">
            <label for="edit_orario_rientro">
              Orario Rientro <span id="labelOrarioOptional" style="color: #94a3b8; font-size: 0.85rem;">(Opzionale se in viaggio)</span>
            </label>
            <input type="time" id="edit_orario_rientro" name="orario_rientro">
          </div>
        </div>

        <div id="kmCalculationEdit" style="margin-top: 1rem; padding: 1rem; background: #10b981; border-radius: 8px; display: none;">
          <strong style="color: white; font-size: 1.1rem;">KM Percorsi: <span id="kmPercorsiEdit">0</span></strong>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_numero_scheda_dkv">Numero Scheda DKV</label>
            <input type="text" id="edit_numero_scheda_dkv" name="numero_scheda_dkv">
          </div>

          <div class="form-group">
            <label for="edit_importo_rifornimento">Importo Rifornimento (‚Ç¨)</label>
            <input type="number" id="edit_importo_rifornimento" name="importo_rifornimento" step="0.01">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_numero_aziendale">Numero Aziendale</label>
            <input type="text" id="edit_numero_aziendale" name="numero_aziendale">
          </div>

          <div class="form-group">
            <label for="edit_pacchi_resi">Pacchi Resi</label>
            <input type="number" id="edit_pacchi_resi" name="pacchi_resi" min="0">
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">üíæ Salva Modifiche</button>
          <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Annulla</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const reportsData = <%- JSON.stringify(reports) %>;

    function filterByRider(riderId) {
      if (riderId) {
        window.location.href = '/admin/reports/rider/' + riderId;
      } else {
        window.location.href = '/admin/dashboard';
      }
    }

    function editReport(reportId) {
      const report = reportsData.find(r => r.id === reportId);
      if (!report) return;

      document.getElementById('edit_report_id').value = report.id;
      document.getElementById('edit_current_status').value = report.status || 'completato';
      document.getElementById('edit_targa_furgone').value = report.targa_furgone;
      document.getElementById('edit_codice_rotta').value = report.codice_rotta;
      document.getElementById('edit_km_partenza').value = report.km_partenza;
      document.getElementById('edit_km_rientro').value = report.km_rientro || '';
      document.getElementById('edit_orario_rientro').value = report.orario_rientro || '';
      document.getElementById('edit_numero_scheda_dkv').value = report.numero_scheda_dkv || '';
      document.getElementById('edit_importo_rifornimento').value = report.importo_rifornimento || '';
      document.getElementById('edit_numero_aziendale').value = report.numero_aziendale || '';
      document.getElementById('edit_pacchi_resi').value = report.pacchi_resi || '';

      // Mostra warning se status = 'partito'
      const statusWarning = document.getElementById('statusWarning');
      if (report.status === 'partito') {
        statusWarning.style.display = 'block';
      } else {
        statusWarning.style.display = 'none';
      }

      // Calcola km percorsi se disponibili
      updateKmCalculationEdit();

      document.getElementById('editForm').action = '/admin/report/update/' + reportId;
      document.getElementById('editModal').style.display = 'block';
    }

    // Calcola KM percorsi in tempo reale nel form edit
    function updateKmCalculationEdit() {
      const kmPartenza = parseInt(document.getElementById('edit_km_partenza').value);
      const kmRientro = parseInt(document.getElementById('edit_km_rientro').value);
      
      if (kmPartenza && kmRientro && kmRientro >= kmPartenza) {
        const kmPercorsi = kmRientro - kmPartenza;
        document.getElementById('kmPercorsiEdit').textContent = kmPercorsi;
        document.getElementById('kmCalculationEdit').style.display = 'block';
      } else {
        document.getElementById('kmCalculationEdit').style.display = 'none';
      }
    }

    // Aggiungi listener per aggiornamento real-time
    document.addEventListener('DOMContentLoaded', function() {
      const kmPartenzaInput = document.getElementById('edit_km_partenza');
      const kmRientroInput = document.getElementById('edit_km_rientro');
      
      if (kmPartenzaInput) {
        kmPartenzaInput.addEventListener('input', updateKmCalculationEdit);
      }
      if (kmRientroInput) {
        kmRientroInput.addEventListener('input', updateKmCalculationEdit);
      }
    });

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function deleteReport(reportId) {
      if (confirm('Sei sicuro di voler eliminare questo report?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/report/delete/' + reportId;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Funzione per aprire il modal delle foto
    function openPhotoModal(photoUrl, caption) {
      // Rimuovi modal esistente se presente
      const existingModal = document.getElementById('photoModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Crea il modal
      const modal = document.createElement('div');
      modal.id = 'photoModal';
      modal.className = 'photo-modal';
      modal.innerHTML = `
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <img class="photo-modal-content" src="${photoUrl}" alt="${caption}">
        <div class="photo-modal-caption">${caption}</div>
      `;
      document.body.appendChild(modal);

      // Mostra il modal
      setTimeout(() => {
        modal.style.display = 'flex';
      }, 10);
    }

    function closePhotoModal() {
      const modal = document.getElementById('photoModal');
      if (modal) {
        modal.style.display = 'none';
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
    }

    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const photoModal = document.getElementById('photoModal');
      
      if (event.target == editModal) {
        closeEditModal();
      }
      if (event.target == photoModal) {
        closePhotoModal();
      }
    }

    // Ripopola i campi di ricerca se ci sono filtri attivi
    document.addEventListener('DOMContentLoaded', function() {
      <% if (searchFilters) { %>
        <% if (searchFilters.rider) { %>
          document.getElementById('searchRider').value = '<%= searchFilters.rider %>';
        <% } %>
        <% if (searchFilters.data) { %>
          document.getElementById('searchData').value = '<%= searchFilters.data %>';
        <% } %>
        <% if (searchFilters.rotta) { %>
          document.getElementById('searchRotta').value = '<%= searchFilters.rotta %>';
        <% } %>
        <% if (searchFilters.targa) { %>
          document.getElementById('searchTarga').value = '<%= searchFilters.targa %>';
        <% } %>
      <% } %>

      // Inizializza contatori stato
      updateStatusCounts();
    });

    // ===== FILTRO RAPIDO PER STATO =====
    let currentFilter = 'all';

    function updateStatusCounts() {
      const allRows = document.querySelectorAll('.data-table tbody tr');
      let countPartito = 0;
      let countCompletato = 0;

      allRows.forEach(row => {
        if (row.classList.contains('row-in-viaggio')) {
          countPartito++;
        } else {
          countCompletato++;
        }
      });

      document.getElementById('countAll').textContent = allRows.length;
      document.getElementById('countPartito').textContent = countPartito;
      document.getElementById('countCompletato').textContent = countCompletato;

      // Evidenzia se ci sono rider in viaggio
      const btnPartito = document.getElementById('btnPartito');
      if (countPartito > 0) {
        btnPartito.style.animation = 'pulse-warning 2s infinite';
      }
    }

    function filterStatus(status) {
      currentFilter = status;
      const allRows = document.querySelectorAll('.data-table tbody tr');
      
      // Reset stili bottoni
      document.getElementById('btnAll').style.opacity = '0.6';
      document.getElementById('btnPartito').style.opacity = '0.6';
      document.getElementById('btnCompletato').style.opacity = '0.6';

      // Evidenzia bottone attivo
      if (status === 'all') {
        document.getElementById('btnAll').style.opacity = '1';
      } else if (status === 'partito') {
        document.getElementById('btnPartito').style.opacity = '1';
      } else {
        document.getElementById('btnCompletato').style.opacity = '1';
      }

      // Filtra righe
      allRows.forEach(row => {
        if (status === 'all') {
          row.style.display = '';
        } else if (status === 'partito') {
          row.style.display = row.classList.contains('row-in-viaggio') ? '' : 'none';
        } else if (status === 'completato') {
          row.style.display = row.classList.contains('row-in-viaggio') ? 'none' : '';
        }
      });
    }

    // ===== SELEZIONE MULTIPLA E ELIMINAZIONE =====
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.report-checkbox');
      
      checkboxes.forEach(checkbox => {
        // Solo seleziona checkbox visibili
        const row = checkbox.closest('tr');
        if (row.style.display !== 'none') {
          checkbox.checked = selectAllCheckbox.checked;
        }
      });
      
      updateDeleteButton();
    }

    function updateDeleteButton() {
      const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const selectedCountSpan = document.getElementById('selectedCount');
      
      if (checkedBoxes.length > 0) {
        deleteBtn.style.display = 'block';
        selectedCountSpan.textContent = checkedBoxes.length;
      } else {
        deleteBtn.style.display = 'none';
      }

      // Aggiorna stato "Seleziona tutti"
      const allCheckboxes = Array.from(document.querySelectorAll('.report-checkbox'));
      const visibleCheckboxes = allCheckboxes.filter(cb => cb.closest('tr').style.display !== 'none');
      const allVisibleChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
      document.getElementById('selectAll').checked = allVisibleChecked;
    }

    function deleteSelected() {
      const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
      const ids = Array.from(checkedBoxes).map(cb => cb.value);
      
      if (ids.length === 0) return;

      const confirmMsg = `Sei sicuro di voler eliminare ${ids.length} report selezionati?\n\n‚ö†Ô∏è Questa azione √® irreversibile!`;
      
      if (confirm(confirmMsg)) {
        // Crea form per inviare array di IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/report/delete-multiple';
        
        // Usa 'reportIds' senza [] per compatibilit√† Express
        ids.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'reportIds';  // Cambiato da 'reportIds[]'
          input.value = id;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Reset selezione quando cambia filtro
    const originalFilterStatus = filterStatus;
    filterStatus = function(status) {
      originalFilterStatus(status);
      document.getElementById('selectAll').checked = false;
      document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
      updateDeleteButton();
    };

    // ===== ORDINAMENTO TABELLA =====
    let currentSort = { column: null, direction: 'asc' };

    function sortTable(column) {
      const tbody = document.querySelector('#data-table tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Determina direzione ordinamento
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      // Ordina le righe
      rows.sort((a, b) => {
        let aValue = a.getAttribute(`data-${column}`) || '';
        let bValue = b.getAttribute(`data-${column}`) || '';
        
        // Gestisci diversi tipi di dati
        if (column === 'data_giorno') {
          // Confronto date (formato YYYY-MM-DD)
          aValue = new Date(aValue);
          bValue = new Date(bValue);
        } else if (column === 'km_partenza' || column === 'km_percorsi') {
          // Confronto numeri
          aValue = parseFloat(aValue) || 0;
          bValue = parseFloat(bValue) || 0;
        } else if (column === 'status') {
          // Ordine personalizzato per status: partito prima di completato
          const statusOrder = { 'partito': 0, 'completato': 1 };
          aValue = statusOrder[aValue] || 2;
          bValue = statusOrder[bValue] || 2;
        } else {
          // Confronto stringhe (case insensitive)
          aValue = aValue.toLowerCase();
          bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Riappende le righe ordinate
      rows.forEach(row => tbody.appendChild(row));
      
      // Aggiorna icone ordinamento
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.textContent = '‚áÖ';
        icon.style.opacity = '0.5';
      });
      
      const currentIcon = document.getElementById(`sort-${column}`);
      if (currentIcon) {
        currentIcon.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
        currentIcon.style.opacity = '1';
      }
    }

    // Export Excel con filtri
    function exportToExcel() {
      const params = new URLSearchParams(window.location.search);
      window.location.href = `/admin/report/export?${params.toString()}`;
    }

    // ===== GESTIONE FURGONI =====
    function updateResetButton() {
      const checkedBoxes = document.querySelectorAll('.vehicle-checkbox:checked');
      const resetBtn = document.getElementById('resetSelectedBtn');
      const selectedCountSpan = document.getElementById('selectedVehicleCount');
      
      if (checkedBoxes.length > 0) {
        resetBtn.style.display = 'block';
        selectedCountSpan.textContent = checkedBoxes.length;
      } else {
        resetBtn.style.display = 'none';
      }
    }

    function resetSelectedAssignments() {
      const checkedBoxes = document.querySelectorAll('.vehicle-checkbox:checked');
      const vehicleIds = Array.from(checkedBoxes).map(cb => cb.value);
      
      if (vehicleIds.length === 0) return;

      const confirmMsg = `Sei sicuro di voler resettare ${vehicleIds.length} assegnamento/i?\n\n‚ö†Ô∏è I furgoni torneranno disponibili!`;
      
      if (confirm(confirmMsg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/assignments/reset-multiple';
        
        vehicleIds.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'vehicleIds';
          input.value = id;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>

  <style>
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .vehicle-card {
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .vehicle-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .vehicle-available {
      background: white;
      border-color: #22c55e;
    }

    .vehicle-assigned {
      background: white;
      border-color: #6366f1;
    }

    .vehicle-checkbox {
      accent-color: #6366f1;
    }

    @media (max-width: 768px) {
      .vehicle-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    function showPhotosModal(reportId, rider, date, posteriore, anteriore, destro, sinistro, interno) {
      const photos = [
        {url: posteriore, label: 'Posteriore'},
        {url: anteriore, label: 'Anteriore'},
        {url: destro, label: 'Lato Destro'},
        {url: sinistro, label: 'Lato Sinistro'},
        {url: interno, label: 'Interno'}
      ].filter(p => p.url);

      let html = `
        <div class="modal" id="photosModal" style="display: flex; z-index: 9999;">
          <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>Foto Furgone - ${rider} - ${date}</h3>
              <span class="modal-close" onclick="document.getElementById('photosModal').remove()">&times;</span>
            </div>
            <div class="modal-body" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
      `;

      photos.forEach(photo => {
        html += `
          <div>
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #64748b;">${photo.label}</h4>
            <img src="${photo.url}" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" 
                 onclick="window.open('${photo.url}', '_blank')">
          </div>
        `;
      });

      html += `
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', html);
    }
  </script>
    </main>
  </div>
</body>
</html>



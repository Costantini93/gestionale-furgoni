<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Admin - Gestionale Furgoni</title>
  <link rel="stylesheet" href="/css/clean-theme.css">
</head>
<body>
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/admin/dashboard" class="sidebar-logo">üöö Gestionale Consegne</a>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/admin/dashboard" class="active"><span class="icon">üìä</span> Dashboard</a></li>
        <li><a href="/admin/dipendenti"><span class="icon">üë•</span> Gestione Dipendenti</a></li>
        <li><a href="/admin/assignments"><span class="icon">üöó</span> Assegnamenti</a></li>
        <li><a href="/admin/maintenance"><span class="icon">üîß</span> Manutenzioni</a></li>
        <li><a href="/auth/logout"><span class="icon">üö™</span> Logout</a></li>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="breadcrumb">
          <span>üè† Gestionale Consegne - ADMIN</span>
        </div>
        <div class="topbar-right">
          <div class="user-info">
            <span>üë§ <%= user.nome %> <%= user.cognome %></span>
          </div>
          <a href="/auth/logout" class="btn btn-secondary btn-sm">üö™ Logout</a>
        </div>
      </div>

      <div class="container">

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success">
        ‚úÖ <%= success[0] %>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert alert-error">
        ‚ö†Ô∏è <%= error[0] %>
      </div>
    <% } %>

        <!-- Stato Furgoni -->
        <div class="card">
          <div class="card-header">
            <h3>üöö Stato Furgoni</h3>
            <div style="display: flex; gap: 10px;">
              <button 
                id="resetSelectedBtn" 
                class="btn btn-warning btn-sm" 
                onclick="resetSelectedAssignments()" 
                style="display: none;">
                üîÑ Reset Selezionati (<span id="selectedVehicleCount">0</span>)
              </button>
              <a href="/admin/assignments" class="btn btn-primary btn-sm">
                ‚ûï Nuova Assegnazione
              </a>
            </div>
          </div>
          <div class="card-body">

      <% if (vehicles && vehicles.length > 0) { %>
        <div class="vehicle-grid">
          <% vehicles.forEach(vehicle => { %>
            <div class="vehicle-card <%= vehicle.status === 'assegnato' ? 'vehicle-assigned' : 'vehicle-available' %>">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">
                    <%= vehicle.status === 'assegnato' ? 'üöö' : 'üÖøÔ∏è' %> <%= vehicle.license_plate %>
                  </h4>
                  <p style="margin: 0 0 0.5rem 0; color: #64748b; font-size: 0.9rem;">
                    <%= vehicle.model %> (<%= vehicle.anno %>)
                  </p>
                </div>
                <% if (vehicle.status === 'assegnato') { %>
                  <input type="checkbox" class="vehicle-checkbox" value="<%= vehicle.id %>" onchange="updateResetButton()" style="width: 20px; height: 20px; cursor: pointer;">
                <% } %>
              </div>
              
              <% if (vehicle.status === 'assegnato' && vehicle.current_assignment) { %>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366f1;">
                  <p style="margin: 0; font-size: 0.85rem; color: #6366f1; font-weight: 600;">
                    üë§ Assegnato a: <%= vehicle.current_assignment.rider_nome %> <%= vehicle.current_assignment.rider_cognome %>
                  </p>
                  <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #64748b;">
                    üìÖ Dal <%= formatDate(vehicle.current_assignment.data_assegnazione) %>
                  </p>
                  <% if (vehicle.current_assignment.note) { %>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #475569;">
                      üí¨ <%= vehicle.current_assignment.note %>
                    </p>
                  <% } %>
                </div>
              <% } else { %>
                <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 4px solid #22c55e;">
                  <p style="margin: 0; font-size: 0.85rem; color: #22c55e; font-weight: 600;">
                    ‚úÖ Disponibile
                  </p>
                </div>
              <% } %>
            </div>
          <% }) %>
        </div>

        <!-- Stats rapide -->
        <div style="margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; color: white;">
          <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 1rem;">
            <div style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold;"><%= vehicles.length %></div>
              <div style="font-size: 0.9rem; opacity: 0.9;">üöõ Totale Furgoni</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold;"><%= vehicles.filter(v => v.status === 'assegnato').length %></div>
              <div style="font-size: 0.9rem; opacity: 0.9;">üöö In Uso</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 2rem; font-weight: bold;"><%= vehicles.filter(v => v.status === 'disponibile').length %></div>
              <div style="font-size: 0.9rem; opacity: 0.9;">üÖøÔ∏è Disponibili</div>
            </div>
          </div>
        </div>
      <% } else { %>
        <p class="no-data">Nessun furgone nel sistema. <a href="/admin/assignments">Aggiungi il primo furgone</a></p>
      <% } %>
    </div>

    <!-- Filtri avanzati -->
    <div class="card">
      <h3>üîç Ricerca Avanzata</h3>
      <form method="GET" action="/admin/dashboard">
        <div class="form-row">
          <div class="form-group">
            <label for="searchRider">ÔøΩ Dipendente:</label>
            <select id="searchRider" name="rider">
              <option value="">Tutti i Rider</option>
              <% riders.forEach(rider => { %>
                <option value="<%= rider.id %>">
                  <%= rider.nome %> <%= rider.cognome %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="form-group">
            <label for="searchData">üìÖ Data:</label>
            <input type="text" id="searchData" name="data" placeholder="GG/MM/AAAA" pattern="\d{2}/\d{2}/\d{4}">
          </div>

          <div class="form-group">
            <label for="searchRotta">üó∫Ô∏è Codice Rotta:</label>
            <input type="text" id="searchRotta" name="rotta" placeholder="ES: R001">
          </div>

          <div class="form-group">
            <label for="searchTarga">üöê Targa:</label>
            <input type="text" id="searchTarga" name="targa" placeholder="ES: AB123CD">
          </div>
        </div>

        <div class="form-row" style="gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary">
            üîç Cerca
          </button>
          <a href="/admin/dashboard" class="btn btn-secondary">
            üîÑ Resetta Filtri
          </a>
        </div>
      </form>
      
      <div class="form-row" style="gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(99, 102, 241, 0.2);">
        <button onclick="exportToExcel()" class="btn-export">
          üìä Esporta Excel
        </button>
        <a href="/admin/assignments" class="btn-gradient">
          üöö Assegna Furgone
        </a>
        <a href="/admin/maintenance" class="btn-gradient" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
          üîß Richieste Manutenzione
        </a>
      </div>
    </div>
          </a>
        </div>
      </form>
    </div>

    <!-- Tabella report -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h3 style="margin: 0;">üì¶ Report Consegne</h3>
        
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
          <button 
            id="deleteSelectedBtn" 
            class="btn" 
            onclick="deleteSelected()" 
            style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: none;">
            üóëÔ∏è Elimina Selezionati (<span id="selectedCount">0</span>)
          </button>
          
          <button class="btn btn-secondary" onclick="filterStatus('all')" id="btnAll">
            üìã Tutti (<span id="countAll">0</span>)
          </button>
          <button class="btn btn-warning" onclick="filterStatus('partito')" id="btnPartito">
            üöö In Viaggio (<span id="countPartito">0</span>)
          </button>
          <button class="btn btn-success" onclick="filterStatus('completato')" id="btnCompletato">
            ‚úÖ Rientrati (<span id="countCompletato">0</span>)
          </button>
        </div>
      </div>
      
      <% if (reports.length === 0) { %>
        <p class="no-data">Nessun report disponibile.</p>
      <% } else { %>
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" title="Seleziona tutti">
                </th>
                <th class="sortable" onclick="sortTable('data_giorno')" style="cursor: pointer;">
                  Data <span class="sort-icon" id="sort-data_giorno">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('rider')" style="cursor: pointer;">
                  Rider <span class="sort-icon" id="sort-rider">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('status')" style="cursor: pointer;">
                  üìç Stato <span class="sort-icon" id="sort-status">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('targa_furgone')" style="cursor: pointer;">
                  Targa <span class="sort-icon" id="sort-targa_furgone">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('codice_rotta')" style="cursor: pointer;">
                  Rotta <span class="sort-icon" id="sort-codice_rotta">‚áÖ</span>
                </th>
                <th class="sortable" onclick="sortTable('km_partenza')" style="cursor: pointer;">
                  Km Partenza <span class="sort-icon" id="sort-km_partenza">‚áÖ</span>
                </th>
                <th>Km Rientro</th>
                <th class="sortable" onclick="sortTable('km_percorsi')" style="cursor: pointer;">
                  Km Percorsi <span class="sort-icon" id="sort-km_percorsi">‚áÖ</span>
                </th>
                <th>Orario</th>
                <th>üì∏ Foto</th>
                <th>Firma</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              <% reports.forEach(report => { %>
                <tr id="row-<%= report.id %>" 
                    class="<%= report.status === 'partito' ? 'row-in-viaggio' : '' %>"
                    data-data_giorno="<%= report.data_giorno %>"
                    data-rider="<%= report.nome %> <%= report.cognome %>"
                    data-status="<%= report.status %>"
                    data-targa_furgone="<%= report.targa_furgone %>"
                    data-codice_rotta="<%= report.codice_rotta %>"
                    data-km_partenza="<%= report.km_partenza %>"
                    data-km_percorsi="<%= report.km_rientro ? report.km_rientro - report.km_partenza : 0 %>">
                  <td>
                    <input type="checkbox" class="report-checkbox" value="<%= report.id %>" onchange="updateDeleteButton()">
                  </td>
                  <td><%= formatDate(report.data_giorno) %></td>
                  <td><strong><%= report.nome %> <%= report.cognome %></strong></td>
                  <td>
                    <% if (report.status === 'partito') { %>
                      <span class="badge badge-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #fb923c 100%); animation: pulse-warning 2s infinite;">
                        üöö In Viaggio
                      </span>
                    <% } else { %>
                      <span class="badge badge-success">
                        ‚úÖ Rientrato
                      </span>
                    <% } %>
                  </td>
                  <td><%= report.targa_furgone %></td>
                  <td><%= report.codice_rotta %></td>
                  <td><%= report.km_partenza %></td>
                  <td>
                    <% if (report.km_rientro) { %>
                      <%= report.km_rientro %>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.km_rientro) { %>
                      <strong><%= report.km_rientro - report.km_partenza %></strong>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (report.orario_rientro) { %>
                      <%= report.orario_rientro %>
                    <% } else { %>
                      <span style="color: #94a3b8; font-style: italic;">--</span>
                    <% } %>
                  </td>
                  <td>
                    <div class="photo-thumbnails">
                      <% if (report.foto_posteriore) { %>
                        <img src="<%= report.foto_posteriore %>" class="photo-thumb" alt="Posteriore" 
                             onclick="openPhotoModal('<%= report.foto_posteriore %>', 'Foto Posteriore - <%= report.nome %> <%= report.cognome %> - <%= formatDate(report.data_giorno) %>')">
                      <% } %>
                      <% if (report.foto_anteriore) { %>
                        <img src="<%= report.foto_anteriore %>" class="photo-thumb" alt="Anteriore"
                             onclick="openPhotoModal('<%= report.foto_anteriore %>', 'Foto Anteriore - <%= report.nome %> <%= report.cognome %> - <%= formatDate(report.data_giorno) %>')">
                      <% } %>
                      <% if (report.foto_lato_destro) { %>
                        <img src="<%= report.foto_lato_destro %>" class="photo-thumb" alt="Lato Destro"
                             onclick="openPhotoModal('<%= report.foto_lato_destro %>', 'Lato Destro - <%= report.nome %> <%= report.cognome %> - <%= formatDate(report.data_giorno) %>')">
                      <% } %>
                      <% if (report.foto_lato_sinistro) { %>
                        <img src="<%= report.foto_lato_sinistro %>" class="photo-thumb" alt="Lato Sinistro"
                             onclick="openPhotoModal('<%= report.foto_lato_sinistro %>', 'Lato Sinistro - <%= report.nome %> <%= report.cognome %> - <%= formatDate(report.data_giorno) %>')">
                      <% } %>
                      <% if (report.foto_interno) { %>
                        <img src="<%= report.foto_interno %>" class="photo-thumb" alt="Interno"
                             onclick="openPhotoModal('<%= report.foto_interno %>', 'Interno - <%= report.nome %> <%= report.cognome %> - <%= formatDate(report.data_giorno) %>')">
                      <% } %>
                      <% if (!report.foto_posteriore && !report.foto_anteriore && !report.foto_lato_destro && !report.foto_lato_sinistro && !report.foto_interno) { %>
                        <span style="color: #94a3b8; font-size: 0.85rem;">Nessuna foto</span>
                      <% } %>
                    </div>
                  </td>
                  <td>
                    <% if (report.firma) { %>
                      <span class="badge badge-success">‚úì</span>
                    <% } else { %>
                      <span class="badge badge-error">‚úó</span>
                    <% } %>
                  </td>
                  <td class="actions">
                    <button onclick="editReport(<%= report.id %>)" class="btn-icon" title="Modifica">
                      ‚úèÔ∏è
                    </button>
                    <button onclick="deleteReport(<%= report.id %>)" class="btn-icon" title="Elimina">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Modal Modifica Report -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h3>‚úèÔ∏è Modifica Report</h3>
      
      <div id="statusWarning" style="display: none; background: rgba(245, 158, 11, 0.2); border: 2px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <p style="margin: 0; color: #fbbf24; font-weight: 600;">
          ‚ö†Ô∏è Questo report √® ancora "In Viaggio". Inserisci KM Rientro e Orario per completarlo.
        </p>
      </div>

      <form id="editForm" method="POST">
        <input type="hidden" id="edit_report_id" name="report_id">
        <input type="hidden" id="edit_current_status" name="current_status">
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit_targa_furgone">Targa Furgone</label>
            <input type="text" id="edit_targa_furgone" name="targa_furgone" required>
          </div>

          <div class="form-group">
            <label for="edit_codice_rotta">Codice Rotta</label>
            <input type="text" id="edit_codice_rotta" name="codice_rotta" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_km_partenza">Km Partenza *</label>
            <input type="number" id="edit_km_partenza" name="km_partenza" required>
          </div>

          <div class="form-group">
            <label for="edit_km_rientro">
              Km Rientro <span id="labelKmOptional" style="color: #94a3b8; font-size: 0.85rem;">(Opzionale se in viaggio)</span>
            </label>
            <input type="number" id="edit_km_rientro" name="km_rientro">
          </div>

          <div class="form-group">
            <label for="edit_orario_rientro">
              Orario Rientro <span id="labelOrarioOptional" style="color: #94a3b8; font-size: 0.85rem;">(Opzionale se in viaggio)</span>
            </label>
            <input type="time" id="edit_orario_rientro" name="orario_rientro">
          </div>
        </div>

        <div id="kmCalculationEdit" style="margin-top: 1rem; padding: 1rem; background: #10b981; border-radius: 8px; display: none;">
          <strong style="color: white; font-size: 1.1rem;">üìä KM Percorsi: <span id="kmPercorsiEdit">0</span></strong>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_numero_scheda_dkv">Numero Scheda DKV</label>
            <input type="text" id="edit_numero_scheda_dkv" name="numero_scheda_dkv">
          </div>

          <div class="form-group">
            <label for="edit_importo_rifornimento">Importo Rifornimento (‚Ç¨)</label>
            <input type="number" id="edit_importo_rifornimento" name="importo_rifornimento" step="0.01">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_numero_aziendale">Numero Aziendale</label>
            <input type="text" id="edit_numero_aziendale" name="numero_aziendale">
          </div>

          <div class="form-group">
            <label for="edit_pacchi_resi">Pacchi Resi</label>
            <input type="number" id="edit_pacchi_resi" name="pacchi_resi" min="0">
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">üíæ Salva Modifiche</button>
          <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Annulla</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const reportsData = <%- JSON.stringify(reports) %>;

    function filterByRider(riderId) {
      if (riderId) {
        window.location.href = '/admin/reports/rider/' + riderId;
      } else {
        window.location.href = '/admin/dashboard';
      }
    }

    function editReport(reportId) {
      const report = reportsData.find(r => r.id === reportId);
      if (!report) return;

      document.getElementById('edit_report_id').value = report.id;
      document.getElementById('edit_current_status').value = report.status || 'completato';
      document.getElementById('edit_targa_furgone').value = report.targa_furgone;
      document.getElementById('edit_codice_rotta').value = report.codice_rotta;
      document.getElementById('edit_km_partenza').value = report.km_partenza;
      document.getElementById('edit_km_rientro').value = report.km_rientro || '';
      document.getElementById('edit_orario_rientro').value = report.orario_rientro || '';
      document.getElementById('edit_numero_scheda_dkv').value = report.numero_scheda_dkv || '';
      document.getElementById('edit_importo_rifornimento').value = report.importo_rifornimento || '';
      document.getElementById('edit_numero_aziendale').value = report.numero_aziendale || '';
      document.getElementById('edit_pacchi_resi').value = report.pacchi_resi || '';

      // Mostra warning se status = 'partito'
      const statusWarning = document.getElementById('statusWarning');
      if (report.status === 'partito') {
        statusWarning.style.display = 'block';
      } else {
        statusWarning.style.display = 'none';
      }

      // Calcola km percorsi se disponibili
      updateKmCalculationEdit();

      document.getElementById('editForm').action = '/admin/report/update/' + reportId;
      document.getElementById('editModal').style.display = 'block';
    }

    // Calcola KM percorsi in tempo reale nel form edit
    function updateKmCalculationEdit() {
      const kmPartenza = parseInt(document.getElementById('edit_km_partenza').value);
      const kmRientro = parseInt(document.getElementById('edit_km_rientro').value);
      
      if (kmPartenza && kmRientro && kmRientro >= kmPartenza) {
        const kmPercorsi = kmRientro - kmPartenza;
        document.getElementById('kmPercorsiEdit').textContent = kmPercorsi;
        document.getElementById('kmCalculationEdit').style.display = 'block';
      } else {
        document.getElementById('kmCalculationEdit').style.display = 'none';
      }
    }

    // Aggiungi listener per aggiornamento real-time
    document.addEventListener('DOMContentLoaded', function() {
      const kmPartenzaInput = document.getElementById('edit_km_partenza');
      const kmRientroInput = document.getElementById('edit_km_rientro');
      
      if (kmPartenzaInput) {
        kmPartenzaInput.addEventListener('input', updateKmCalculationEdit);
      }
      if (kmRientroInput) {
        kmRientroInput.addEventListener('input', updateKmCalculationEdit);
      }
    });

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function deleteReport(reportId) {
      if (confirm('Sei sicuro di voler eliminare questo report?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/report/delete/' + reportId;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Funzione per aprire il modal delle foto
    function openPhotoModal(photoUrl, caption) {
      // Rimuovi modal esistente se presente
      const existingModal = document.getElementById('photoModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Crea il modal
      const modal = document.createElement('div');
      modal.id = 'photoModal';
      modal.className = 'photo-modal';
      modal.innerHTML = `
        <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
        <img class="photo-modal-content" src="${photoUrl}" alt="${caption}">
        <div class="photo-modal-caption">${caption}</div>
      `;
      document.body.appendChild(modal);

      // Mostra il modal
      setTimeout(() => {
        modal.style.display = 'flex';
      }, 10);
    }

    function closePhotoModal() {
      const modal = document.getElementById('photoModal');
      if (modal) {
        modal.style.display = 'none';
        setTimeout(() => {
          modal.remove();
        }, 300);
      }
    }

    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const photoModal = document.getElementById('photoModal');
      
      if (event.target == editModal) {
        closeEditModal();
      }
      if (event.target == photoModal) {
        closePhotoModal();
      }
    }

    // Ripopola i campi di ricerca se ci sono filtri attivi
    document.addEventListener('DOMContentLoaded', function() {
      <% if (searchFilters) { %>
        <% if (searchFilters.rider) { %>
          document.getElementById('searchRider').value = '<%= searchFilters.rider %>';
        <% } %>
        <% if (searchFilters.data) { %>
          document.getElementById('searchData').value = '<%= searchFilters.data %>';
        <% } %>
        <% if (searchFilters.rotta) { %>
          document.getElementById('searchRotta').value = '<%= searchFilters.rotta %>';
        <% } %>
        <% if (searchFilters.targa) { %>
          document.getElementById('searchTarga').value = '<%= searchFilters.targa %>';
        <% } %>
      <% } %>

      // Inizializza contatori stato
      updateStatusCounts();
    });

    // ===== FILTRO RAPIDO PER STATO =====
    let currentFilter = 'all';

    function updateStatusCounts() {
      const allRows = document.querySelectorAll('.data-table tbody tr');
      let countPartito = 0;
      let countCompletato = 0;

      allRows.forEach(row => {
        if (row.classList.contains('row-in-viaggio')) {
          countPartito++;
        } else {
          countCompletato++;
        }
      });

      document.getElementById('countAll').textContent = allRows.length;
      document.getElementById('countPartito').textContent = countPartito;
      document.getElementById('countCompletato').textContent = countCompletato;

      // Evidenzia se ci sono rider in viaggio
      const btnPartito = document.getElementById('btnPartito');
      if (countPartito > 0) {
        btnPartito.style.animation = 'pulse-warning 2s infinite';
      }
    }

    function filterStatus(status) {
      currentFilter = status;
      const allRows = document.querySelectorAll('.data-table tbody tr');
      
      // Reset stili bottoni
      document.getElementById('btnAll').style.opacity = '0.6';
      document.getElementById('btnPartito').style.opacity = '0.6';
      document.getElementById('btnCompletato').style.opacity = '0.6';

      // Evidenzia bottone attivo
      if (status === 'all') {
        document.getElementById('btnAll').style.opacity = '1';
      } else if (status === 'partito') {
        document.getElementById('btnPartito').style.opacity = '1';
      } else {
        document.getElementById('btnCompletato').style.opacity = '1';
      }

      // Filtra righe
      allRows.forEach(row => {
        if (status === 'all') {
          row.style.display = '';
        } else if (status === 'partito') {
          row.style.display = row.classList.contains('row-in-viaggio') ? '' : 'none';
        } else if (status === 'completato') {
          row.style.display = row.classList.contains('row-in-viaggio') ? 'none' : '';
        }
      });
    }

    // ===== SELEZIONE MULTIPLA E ELIMINAZIONE =====
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.report-checkbox');
      
      checkboxes.forEach(checkbox => {
        // Solo seleziona checkbox visibili
        const row = checkbox.closest('tr');
        if (row.style.display !== 'none') {
          checkbox.checked = selectAllCheckbox.checked;
        }
      });
      
      updateDeleteButton();
    }

    function updateDeleteButton() {
      const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const selectedCountSpan = document.getElementById('selectedCount');
      
      if (checkedBoxes.length > 0) {
        deleteBtn.style.display = 'block';
        selectedCountSpan.textContent = checkedBoxes.length;
      } else {
        deleteBtn.style.display = 'none';
      }

      // Aggiorna stato "Seleziona tutti"
      const allCheckboxes = Array.from(document.querySelectorAll('.report-checkbox'));
      const visibleCheckboxes = allCheckboxes.filter(cb => cb.closest('tr').style.display !== 'none');
      const allVisibleChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
      document.getElementById('selectAll').checked = allVisibleChecked;
    }

    function deleteSelected() {
      const checkedBoxes = document.querySelectorAll('.report-checkbox:checked');
      const ids = Array.from(checkedBoxes).map(cb => cb.value);
      
      if (ids.length === 0) return;

      const confirmMsg = `Sei sicuro di voler eliminare ${ids.length} report selezionati?\n\n‚ö†Ô∏è Questa azione √® irreversibile!`;
      
      if (confirm(confirmMsg)) {
        // Crea form per inviare array di IDs
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/report/delete-multiple';
        
        // Usa 'reportIds' senza [] per compatibilit√† Express
        ids.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'reportIds';  // Cambiato da 'reportIds[]'
          input.value = id;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Reset selezione quando cambia filtro
    const originalFilterStatus = filterStatus;
    filterStatus = function(status) {
      originalFilterStatus(status);
      document.getElementById('selectAll').checked = false;
      document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
      updateDeleteButton();
    };

    // ===== ORDINAMENTO TABELLA =====
    let currentSort = { column: null, direction: 'asc' };

    function sortTable(column) {
      const tbody = document.querySelector('#data-table tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Determina direzione ordinamento
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      // Ordina le righe
      rows.sort((a, b) => {
        let aValue = a.getAttribute(`data-${column}`) || '';
        let bValue = b.getAttribute(`data-${column}`) || '';
        
        // Gestisci diversi tipi di dati
        if (column === 'data_giorno') {
          // Confronto date (formato YYYY-MM-DD)
          aValue = new Date(aValue);
          bValue = new Date(bValue);
        } else if (column === 'km_partenza' || column === 'km_percorsi') {
          // Confronto numeri
          aValue = parseFloat(aValue) || 0;
          bValue = parseFloat(bValue) || 0;
        } else if (column === 'status') {
          // Ordine personalizzato per status: partito prima di completato
          const statusOrder = { 'partito': 0, 'completato': 1 };
          aValue = statusOrder[aValue] || 2;
          bValue = statusOrder[bValue] || 2;
        } else {
          // Confronto stringhe (case insensitive)
          aValue = aValue.toLowerCase();
          bValue = bValue.toLowerCase();
        }
        
        if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
      
      // Riappende le righe ordinate
      rows.forEach(row => tbody.appendChild(row));
      
      // Aggiorna icone ordinamento
      document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.textContent = '‚áÖ';
        icon.style.opacity = '0.5';
      });
      
      const currentIcon = document.getElementById(`sort-${column}`);
      if (currentIcon) {
        currentIcon.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
        currentIcon.style.opacity = '1';
      }
    }

    // Export Excel con filtri
    function exportToExcel() {
      const params = new URLSearchParams(window.location.search);
      window.location.href = `/admin/report/export?${params.toString()}`;
    }

    // ===== GESTIONE FURGONI =====
    function updateResetButton() {
      const checkedBoxes = document.querySelectorAll('.vehicle-checkbox:checked');
      const resetBtn = document.getElementById('resetSelectedBtn');
      const selectedCountSpan = document.getElementById('selectedVehicleCount');
      
      if (checkedBoxes.length > 0) {
        resetBtn.style.display = 'block';
        selectedCountSpan.textContent = checkedBoxes.length;
      } else {
        resetBtn.style.display = 'none';
      }
    }

    function resetSelectedAssignments() {
      const checkedBoxes = document.querySelectorAll('.vehicle-checkbox:checked');
      const vehicleIds = Array.from(checkedBoxes).map(cb => cb.value);
      
      if (vehicleIds.length === 0) return;

      const confirmMsg = `Sei sicuro di voler resettare ${vehicleIds.length} assegnamento/i?\n\n‚ö†Ô∏è I furgoni torneranno disponibili!`;
      
      if (confirm(confirmMsg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/assignments/reset-multiple';
        
        vehicleIds.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'vehicleIds';
          input.value = id;
          form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>

  <style>
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .vehicle-card {
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .vehicle-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .vehicle-available {
      background: white;
      border-color: #22c55e;
    }

    .vehicle-assigned {
      background: white;
      border-color: #6366f1;
    }

    .vehicle-checkbox {
      accent-color: #6366f1;
    }

    @media (max-width: 768px) {
      .vehicle-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
    </main>
  </div>
</body>
</html>


